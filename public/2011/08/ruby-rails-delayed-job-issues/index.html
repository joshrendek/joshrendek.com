<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.25.1" />

<meta property="og:title" content="Ruby on Rails: Delayed Job issues" />
<meta property="og:description" content="Thankfully the issue tracker on Github was a great help, but I recently ran into two issues I&rsquo;ve never had the pleasure of encountering before while using DJ:
&ldquo;nil is not a symbol&rdquo; as a failure message. When running the background jobs for Servly, this was occurring on the status checks (its a pretty long list of checks on a server to reduce false positives, including distributed pings).Â The problem with having the longer definition was the way DJ serializes the ruby code to store in the database." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://joshrendek.com/2011/08/ruby-rails-delayed-job-issues/" />



<meta property="article:published_time" content="2011-08-10T01:48:12&#43;00:00"/>
<meta property="article:modified_time" content="2011-08-10T01:48:12&#43;00:00"/>













  <meta name="twitter:card" content="summary"/>



<meta name="twitter:text:title" content="Ruby on Rails: Delayed Job issues"/>
<meta name="twitter:title" content="Ruby on Rails: Delayed Job issues"/>
<meta name="twitter:description" content="Thankfully the issue tracker on Github was a great help, but I recently ran into two issues I&rsquo;ve never had the pleasure of encountering before while using DJ:
&ldquo;nil is not a symbol&rdquo; as a failure message. When running the background jobs for Servly, this was occurring on the status checks (its a pretty long list of checks on a server to reduce false positives, including distributed pings).Â The problem with having the longer definition was the way DJ serializes the ruby code to store in the database."/>




<meta itemprop="name" content="Ruby on Rails: Delayed Job issues">
<meta itemprop="description" content="Thankfully the issue tracker on Github was a great help, but I recently ran into two issues I&rsquo;ve never had the pleasure of encountering before while using DJ:
&ldquo;nil is not a symbol&rdquo; as a failure message. When running the background jobs for Servly, this was occurring on the status checks (its a pretty long list of checks on a server to reduce false positives, including distributed pings).Â The problem with having the longer definition was the way DJ serializes the ruby code to store in the database.">


<meta itemprop="dateModified" content="2011-08-10T01:48:12&#43;00:00" />
<meta itemprop="wordCount" content="483">



<meta itemprop="keywords" content="" />


<link rel="stylesheet" type="text/css" href="/css/layout.css" />
<link rel="stylesheet" type="text/css" href="/css/pygments.css" />
<link rel="stylesheet" type="text/css" href="/css/color-dark.css" />


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-3754808-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


<title>


     Ruby on Rails: Delayed Job issues 

</title>

<script src="/js/highlight.min.js"></script>
<link rel="stylesheet" href="/css/tomorrow-night.min.css" />
<script>hljs.initHighlightingOnLoad();</script>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://joshrendek.com">
        <span class='blue-brace'>{</span>
        Josh Rendek
        <span class='blue-brace'>}</span>
      </a>
      <div class="header-subtitle">
        <h2>
          <span class="heart">&lt;3</span> Ruby &amp; Go
        </h2>
      </div>
    </div> 
  </nav>
  <nav>
      
      
      <a class="nav-item" href="/"><div class="nav-item-title">Home</div></a>
      
      <a class="nav-item" href="/projects/"><div class="nav-item-title">Projects</div></a>
      
      <a class="nav-item" href="/archives/"><div class="nav-item-title">Archives</div></a>
      
      <a class="nav-item" href="https://devopsbyvideo.com/"><div class="nav-item-title">Screen Casts</div></a>
      
      <a class="nav-item" href="/about/"><div class="nav-item-title">About</div></a>
      
      <a class="nav-item" href="/categories/"><div class="nav-item-title">Categories</div></a>
      
      <a class="nav-item" href="https://github.com/joshrendek/"><div class="nav-item-title">GitHub</div></a>
      
      <a class="nav-item" href="/resume.pdf"><div class="nav-item-title">Resume</div></a>
      
   </nav>
</div>

  
<div class="social-links-header">

  

  

  

  

  

</div>


</header>


<main>
  <div class="articles">
    <article class="post">
      <div class="date"> Aug 10, 2011 - 3 minutes</div>
      <h1 class="title"> Ruby on Rails: Delayed Job issues </h1>
      <div class="content"> <p>Thankfully the <a href="https://github.com/collectiveidea/delayed_job/issues?sort=created&amp;direction=desc&amp;state=open">issue tracker</a> on Github was a great help, but I recently ran into two issues I&rsquo;ve never had the pleasure of encountering before while using DJ:</p>

<p>&ldquo;nil is not a symbol&rdquo; as a failure message. When running the background jobs for Servly, this was occurring on the status checks (its a pretty long list of checks on a server to reduce false positives, including distributed pings).Â  The problem with having the longer definition was the way DJ serializes the ruby code to store in the database. It was originally using a TEXT(65535) field as the data type in MySQL &ndash; <em><strong>changing this to LongText fixed the issue.</strong></em> The mysterious part about this whole issue was it would run fine from the console, but not from the workers (which makes sense in hindsight because of the limited space available for the serialized object in the delayed_job table).</p>

<p>Here is a snippet of the stack trace (for anyone who might Google it), and <a href="https://github.com/collectiveidea/delayed_job/issues/264">the link to the Github Issue</a>:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1 </span><span class="kp">nil</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">symbol</span>
<span class="lineno">2 </span> <span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">delayed_job</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">delayed</span><span class="o">/</span><span class="n">performable_method</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">20</span><span class="ss">:in</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">perform</span><span class="s1">&#39;</span>
<span class="lineno">3 </span><span class="s1"> /usr/local/lib/ruby/gems/1.9.1/gems/delayed_job-2.1.4/lib/delayed/backend/base.rb:87:in&lt;/code&gt;invoke_job&#39;</span>
<span class="lineno">4 </span> <span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">delayed_job</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">delayed</span><span class="o">/</span><span class="n">worker</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">120</span><span class="ss">:in</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">block</span> <span class="p">(</span><span class="mi">2</span> <span class="n">levels</span><span class="p">)</span> <span class="k">in</span> <span class="n">run</span><span class="s1">&#39;</span>
<span class="lineno">5 </span><span class="s1"> /usr/local/lib/ruby/1.9.1/timeout.rb:57:in&lt;/code&gt;timeout&#39;</span>
<span class="lineno">6 </span> <span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">delayed_job</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">delayed</span><span class="o">/</span><span class="n">worker</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">120</span><span class="ss">:in</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">block</span> <span class="k">in</span> <span class="n">run</span><span class="s1">&#39;</span>
<span class="lineno">7 </span><span class="s1"> /usr/local/lib/ruby/1.9.1/benchmark.rb:309:in&lt;/code&gt;realtime&#39;</span>
<span class="lineno">8 </span> <span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">delayed_job</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">delayed</span><span class="o">/</span><span class="n">worker</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">119</span><span class="ss">:in</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">run</span><span class="s1">&#39;</span>
<span class="lineno">9 </span><span class="s1"> /usr/local/lib/ruby/gems/1.9.1/gems/delayed_job-2.1.4/lib/delayed/worker.rb:177:in&lt;/code&gt;reserve_and_run_one_job&#39;</span>
</code></pre></div>


<p>The <a href="https://github.com/collectiveidea/delayed_job/issues/277">second issue</a> was a combination of things:</p>

<p>The worker resides on a separate node from the main application stack and connects to the database remotely (still over a private LAN). The first thing I noticed was workers dieing silently; a lot of hits on Google pointed to MySQL losing its connection (the default in database.yml/ActiveRecordÂ  is reconnect: false) &ndash; changing this to reconnect: true fixed that issue of workers dieing silently.</p>

<p>Another problem with workers dieing off silently was a lack of information; adding these two lines to the delayed_job_config initializer produced a lot more meaningful errors:</p>

<p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1 </span><span class="no">Delayed</span><span class="o">::</span><span class="no">Worker</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
<span class="lineno">2 </span><span class="no">Delayed</span><span class="o">::</span><span class="no">Worker</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">auto_flushing</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
</p>

<p>And finally &ndash; a version specific bug; delayed_job was running into race conditions on locking jobs it was working on:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1 </span><span class="no">Mysql2</span><span class="o">::</span><span class="ss">Error</span><span class="p">:</span> <span class="no">Deadlock</span> <span class="n">found</span> <span class="k">when</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">lock</span><span class="p">;</span> <span class="n">try</span> <span class="n">restarting</span> <span class="ss">transaction</span><span class="p">:</span> <span class="no">UPDATE</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">delayed_jobs</span><span class="o">&lt;</span><span class="sr">/code&gt; SET locked_at = &#39;2011-08-08 21:30:10&#39;, locked_by = &#39;delayed_job.10 host:226237 pid:27929&#39; WHERE ((run_at &lt;= &#39;2011-08-08 21:30:10&#39; AND (locked_at IS NULL OR locked_at &lt; &#39;2011-08-08 21:15:10&#39;) OR locked_by = &#39;delayed_job.10 host:226237 pid:27929&#39;) AND failed_at IS NULL) ORDER BY priority ASC, run_at ASC LIMIT 1 Mysql2::Error: Deadlock found when trying to get lock; try restarting transaction: UPDATE &lt;code&gt;delayed_jobs&lt;/</span><span class="n">code</span><span class="o">&gt;</span> <span class="no">SET</span> <span class="n">locked_at</span> <span class="o">=</span> <span class="s1">&#39;2011-08-08 21:30:10&#39;</span><span class="p">,</span> <span class="n">locked_by</span> <span class="o">=</span> <span class="s1">&#39;delayed_job.0 host:226237 pid:27869&#39;</span> <span class="no">WHERE</span> <span class="p">((</span><span class="n">run_at</span> <span class="o">&lt;=</span> <span class="s1">&#39;2011-08-08 21:30:10&#39;</span> <span class="no">AND</span> <span class="p">(</span><span class="n">locked_at</span> <span class="no">IS</span> <span class="no">NULL</span> <span class="no">OR</span> <span class="n">locked_at</span> <span class="o">&lt;</span> <span class="s1">&#39;2011-08-08 21:15:10&#39;</span><span class="p">)</span> <span class="no">OR</span> <span class="n">locked_by</span> <span class="o">=</span> <span class="s1">&#39;delayed_job.0 host:226237 pid:27869&#39;</span><span class="p">)</span> <span class="no">AND</span> <span class="n">failed_at</span> <span class="no">IS</span> <span class="no">NULL</span><span class="p">)</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="n">priority</span> <span class="no">ASC</span><span class="p">,</span> <span class="n">run_at</span> <span class="no">ASC</span> <span class="no">LIMIT</span> <span class="mi">1</span>
</code></pre></div>


<p>Upgrading from delayed_job 2.1.2 to 2.1.4 fixed the issue; apparently 2.1.3 may have also been affected.</p>

<p>Aside from these few issues delayed job has been wonderful to use in production and will continue to be used for handling all of Servly&rsquo;s background tasks and processes.</p>
 </div>
      <footer class="post-footer">

  <div class="post-footer-data">
    
<div class="tags">
    
</div>

  </div>

</footer>


  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'bluescripts';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>
  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




    </article>
  </div>
  <div class="sidebar">
  <section>
    <h1>Projects & Software</h1>
    <ul>
      <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
      <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
      <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

      <li><a href="/projects/">View More</a>

      <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
      <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
    </ul>
  </section>

  <section>
    <h1>Other Blogs</h1>
    <ul>
      <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
      <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
    </ul>
  </section>

  <section>
    <h1>Recent Posts</h1>
    <ul>
      
      <li><a href="https://joshrendek.com/2016/06/building-honeypots-and-analyzing-linux-malware/">Building honeypots and analyzing linux malware</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a distributed WaitGroup with Go and Redis</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and ping: sendmsg: Operation not permitted</a></li>
      
      <li><a href="https://joshrendek.com/2015/10/influx-alert/">Influx Alert</a></li>
      
    </ul>
  </section>

</div>

</main>
  <footer>

  <div class="social-links-footer">

  

  

  

  

  

  <div class="social-link">
  <a href="https://joshrendek.com/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright"> © Copyright 2008-2017 Josh Rendek </div>

  </footer>

</body>
</html>

