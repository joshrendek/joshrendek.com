
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a Distributed WaitGroup With Go and Redis - Josh Rendek</title>
  <meta name="author" content="Josh Rendek">

  
  <meta name="description" content="If you&rsquo;ve done any concurrency work in Go you&rsquo;ve used WaitGroups. They&rsquo;re awesome! Now lets say you have a bunch of workers that do &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Josh Rendek" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3754808-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">
      <span class="blue-brace">{</span>Josh Rendek<span class="blue-brace">}</span>
  </a></h1>
  
  <div class="subtitle">
  <h2>
    <span class="heart"><3</span> Ruby &amp; Go
  </h2>
  </div>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:joshrendek.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="https://devopsbyvideo.com/">Screen Casts</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/resume/">Resum√©</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="https://github.com/joshrendek">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building a Distributed WaitGroup With Go and Redis</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-08T20:30:07-05:00" pubdate data-updated="true">Nov 8<sup>th</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>If you&rsquo;ve done any concurrency work in Go you&rsquo;ve used WaitGroups. They&rsquo;re awesome!</p>

<p>Now lets say you have a bunch of workers that do some stuff, but at some point they all need to hit a single API that your rate limited against.</p>

<p>You could move to just using a single process and limiting it that way, but that doesn&rsquo;t scale out very well.</p>

<p>While there are quite a few distributed lock libraries in Go, I didn&rsquo;t find any that worked similarly to WaitGroups, so I set out to write one.</p>

<p>( If you just want the library, head on over to Github <a href="https://github.com/joshrendek/redis-rate-limiter">https://github.com/joshrendek/redis-rate-limiter</a> )</p>

<p>Design goals:</p>

<ul>
<li>Prevent deadlocks</li>
<li>Hard limit on concurrency (dont accidentally creep over)</li>
<li>Keep it simple to use</li>
<li>Use redis</li>
<li>Keep the design similar to <code>sync.WaitGroup</code> by using Add() and Done()</li>
</ul>


<p>Initially I started off using <code>INCR</code>/<code>DECR</code> with <code>WATCH</code>. This somewhat worked but was causing the bucket to over-flow and go above the limit I defined.</p>

<p>Eventually I found the <code>SETNX</code> command and decided using a global lock with that around adding was the way to go.</p>

<p>So the final design goes through this flow for Add():</p>

<ol>
<li>Use SETNX to check if a key exists; loop until it doesn&rsquo;t error (aka the lock is available for acquiring)</li>
<li>Immediately add an expiration to the lock key once acquired so we don&rsquo;t deadlock</li>
<li>Check the current number of workers running; wait until it is below the max rate</li>
<li>Generate a uuid for the worker lock, use this to SET a key and also add to a worker set</li>
<li>Set an expiration on the worker lock key based on uuid so the worker doesn&rsquo;t deadlock</li>
<li>Unlock the global lock from SETNX by deleting the key</li>
<li>Clean old, potentially locked workers</li>
</ol>


<p>Removing is much simpler with Done():</p>

<ol>
<li>Delete the worker lock key</li>
<li>Remove the worker lock from the worker set</li>
</ol>


<p>For (1) we want to make sure we don&rsquo;t hammer Redis or the CPU - so we make sure we can pass an option for a sleep duration while busy-waiting.</p>

<p>(2) Prevents the global lock from stalling out if a worker is cancelled in the middle of a lock acquisition.</p>

<p>Waiting for workers in (3) is done by making sure the cardinanality ( <code>SCARD</code> ) of the worker set is less than the worker limit. We loop and wait until this count goes down so we don&rsquo;t exceed our limit.</p>

<p>(4) and (5) uses a UUID library to generate a unique id for the worker lock name/value. This gets added via <code>SADD</code> to the wait group worker set and also set as a key as well.
We set a key with a TTL based on the UUID so we can remove it from the set via another method if it no longer exists.</p>

<p>(6) frees the global lock allowing other processes to acquire it while they wait in (1).</p>

<p>To clear old locks in (7) we need to take the members in the worker set and then query with <code>EXISTS</code> to see if the key still exists.
If it doesn&rsquo;t exist but it is still in the set, we know something bad happened. At this point we need to remove it from the
worker set so that the slot frees up. This will prevent worker deadlocks from happening if it fails to reach the Done() function.</p>

<p>The <code>Add()</code> function returns a UUID string that you then pass to <code>Done(uuid)</code> to remove the worker locks. I think this was the simplest approach for doing this however if you have other ideas let me know!</p>

<p>That&rsquo;s it! We now have a distributed wait group written in go as a library. You can see the source and how to use it over at <a href="https://github.com/joshrendek/redis-rate-limiter">https://github.com/joshrendek/redis-rate-limiter</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Josh Rendek</span></span>

      








  


<time datetime="2015-11-08T20:30:07-05:00" pubdate data-updated="true">Nov 8<sup>th</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/categories/golang/'>golang</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/" data-via="" data-counturl="http://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2015/11/docker-and-ping-sendmsg-operation-not-permitted/" title="Previous Post: Docker and ping: sendmsg: Operation not permitted">&laquo; Docker and ping: sendmsg: Operation not permitted</a>
      
      
        <a class="basic-alignment right" href="/2015/11/understanding-elasticsearch-performance/" title="Next Post: Understanding ElasticSearch Performance">Understanding ElasticSearch Performance &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Projects & Software</h1>
  <ul>
    <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
    <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
    <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

    <li><a href="/projects/">View More</a>

    <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
    <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
  </ul>
</section>

<section>
  <h1>Other Blogs</h1>
  <ul>
    <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
    <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/06/building-honeypots-and-analyzing-linux-malware/">Building Honeypots and Analyzing Linux Malware</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a Distributed WaitGroup With Go and Redis</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and Ping: Sendmsg: Operation Not Permitted</a>
      </li>
    
      <li class="post">
        <a href="/2015/10/influx-alert/">Influx Alert</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/getting-upstart-to-log-to-syslog-with-tags/">Getting Upstart to Log to Syslog With Tags</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/golang-performance-tips/">Golang Performance Tips</a>
      </li>
    
  </ul>
</section>







  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Josh Rendek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluescripts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/';
        var disqus_url = 'http://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
