
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Understanding ElasticSearch Performance - Josh Rendek</title>
  <meta name="author" content="Josh Rendek">

  
  <meta name="description" content="Performance before and after Optimizations When working with billions of documents in your Elasticsearch cluster, there are a few important things to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://joshrendek.com/2015/11/understanding-elasticsearch-performance">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Josh Rendek" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3754808-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">
      <span class="blue-brace">{</span>Josh Rendek<span class="blue-brace">}</span>
  </a></h1>
  
  <div class="subtitle">
  <h2>
    <span class="heart"><3</span> Ruby &amp; Go
  </h2>
  </div>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:joshrendek.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="https://devopsbyvideo.com/">Screen Casts</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/resume/">Resum√©</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="https://github.com/joshrendek">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Understanding ElasticSearch Performance</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-26T12:05:13-05:00" pubdate data-updated="true">Nov 26<sup>th</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><center><em>Performance before and after Optimizations</em></center>


<p><img src="/images/worker_stats.png" alt="" /></p>

<p>When working with billions of documents in your Elasticsearch cluster, there are a few important things to keep in mind:</p>

<ul>
<li>Look at what the big players do (Elasticsearch/Kibana) for organization and planning</li>
<li>Experiment with index sizes that make sense for your business, don&rsquo;t just assume 1 index for a billion documents is a good idea (even if you N shards)</li>
<li>Understand which metrics to monitor when you are performance testing your cluster</li>
<li>Monitor all points of ingestion: Elasticsearch, Load balancers (ELB, HAProxy, etc), and your application code that is inserting</li>
</ul>


<h3>What do the big players do?</h3>

<p>Split by date ranges. Based on your data, decide whether daily, weekly, or even monthly splits are best for your dataset.
<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_limiting_memory_usage.html">Elasticsearch reccomends not going over 30-32G per shard based on current JVM memory reccomendations</a>.
The reason they reccomend to stay below 32G of ram per shard is that after that, the JVM will use uncompressed pointers which means internal pointers go from 4 bytes to 8 bytes, which (depending on your memory size) can lead to decreased
heap available and also increased GC times from the JVM.</p>

<p>Don&rsquo;t allocate more than 50% of your system memory for the JVM. Your kernel will cache files and help keep performance up.
Over-allocating the JVM can lead to poor performance from the underlying engine, Lucene,
which relies on the OS cache as well as the JVM to do searches.</p>

<p>Understand your users: other devs, other systems, etc. Don&rsquo;t do <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/pagination.html">deep pagination</a>
instead, use <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/scan-scroll.html">scan and scroll</a>.
Turn on slow logging to find any queries doing this or returning to many points of data per query.</p>

<h3>Index Sizing and Memory</h3>

<p>Keeping in mind the 30-32G per shard reccomendation, this will determine the number of shards per dataset.
Remember shards are not modifiable but replicas are. Shards will increase indexing performance, while replicas will increase search performance.</p>

<p>Overwhelmed and can&rsquo;t figure out what to do? Just start with an index and see how things go.
Using alias&rsquo;s you can create another index later on and map both of them together for searching (and eventually delete the old one if the data expires).
If you start out with alias&rsquo;s being used, transitions can be seemless (no need to redeploy to point to the new alias/index name).</p>

<h3>Metrics to monitor</h3>

<p>Use the plugin community to monitor your cluster: <a href="http://www.elastichq.org/">ElasticHQ</a>,
<a href="http://bigdesk.org/">BigDesk</a>, <a href="https://github.com/mobz/elasticsearch-head">Head</a>
and <a href="https://github.com/karmi/elasticsearch-paramedic">Paramedic</a>.</p>

<p>Watch for refresh/merge/flush time (ElasticHQ makes this available under Node Diagnostics).
For example, with a large index (1TB) that has frequent updates or deletions,
in order for the data to actually be freed from the disk and cluster fully, a merge must be performed.
When the number of segments in a cluster gets to large, this can cause issues
for refreshing and merging.</p>

<p>The basic idea is the larger your index, the more segments, and the
more optimization steps that need to be performed. Automatic flushes happen every
few seconds so more segments get created - as you can imagine this gets compounded the
larger your index is.
<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/merge-process.html">You can see a full rundown of how deleting and updating works in the documentation</a>.</p>

<p>By seperating our indexes into smaller datasets (by day, week, or month) we can eliminate some of the issues that pop up.
For example, a large number of segments can cause search performance issues
until an optmize command is run (which in itself can cause high IO and make your search unavailable).
By reducing the data we reduce the time these operations can take. We also end up at
a point where no new data is inserted into the old indexes, so no further
optimizations need to be done on them, only new indexes.
Any acitivity on the old indexes then should only be from searching and will
reduce the IO requirements from the cluster for those shards/indexes.</p>

<p>This also greatly simplifies purging old data. Instead of having to have the
cluster do merges and optimizations when we remove old documents, we can
just delete the old indexes and remove them from the aliases. This will also
reduce the IO overhead on your cluster.</p>

<h3>Monitoring Ingestion</h3>

<p>Watch your ELB response time - is it spiking? Check flush, merge, and indexing times.</p>

<p>Add logging to your posts to understand how long each bulk insert is taking. Play with bulk sizes to see what works best for your document/datasize.</p>

<p>When moving from a single large index to aliased indexes, insertion times went from 500ms-1.5s+ to 50ms on average. Our daily processes that were taking half a day to complete, finishing in less than 15 minutes.</p>

<p>Processing 5k log lines per minute? Now we&rsquo;re processing over 6 million.</p>

<p>Taking the time to understand your database and how each part of it works can be worth the effort especially if you&rsquo;re looking for performance gains.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Josh Rendek</span></span>

      








  


<time datetime="2015-11-26T12:05:13-05:00" pubdate data-updated="true">Nov 26<sup>th</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/categories/elasticsearch/'>elasticsearch</a>, <a class='category' href='/categories/golang/'>golang,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://joshrendek.com/2015/11/understanding-elasticsearch-performance/" data-via="" data-counturl="http://joshrendek.com/2015/11/understanding-elasticsearch-performance/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2015/11/building-a-distributed-waitgroup-with-go-and-redis/" title="Previous Post: Building a distributed WaitGroup with Go and Redis">&laquo; Building a distributed WaitGroup with Go and Redis</a>
      
      
        <a class="basic-alignment right" href="/2016/06/building-honeypots-and-analyzing-linux-malware/" title="Next Post: Building honeypots and analyzing linux malware">Building honeypots and analyzing linux malware &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Projects & Software</h1>
  <ul>
    <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
    <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
    <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

    <li><a href="/projects/">View More</a>

    <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
    <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
  </ul>
</section>

<section>
  <h1>Other Blogs</h1>
  <ul>
    <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
    <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/06/building-honeypots-and-analyzing-linux-malware/">Building Honeypots and Analyzing Linux Malware</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a Distributed WaitGroup With Go and Redis</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and Ping: Sendmsg: Operation Not Permitted</a>
      </li>
    
      <li class="post">
        <a href="/2015/10/influx-alert/">Influx Alert</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/getting-upstart-to-log-to-syslog-with-tags/">Getting Upstart to Log to Syslog With Tags</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/golang-performance-tips/">Golang Performance Tips</a>
      </li>
    
  </ul>
</section>







  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Josh Rendek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluescripts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://joshrendek.com/2015/11/understanding-elasticsearch-performance/';
        var disqus_url = 'http://joshrendek.com/2015/11/understanding-elasticsearch-performance/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
