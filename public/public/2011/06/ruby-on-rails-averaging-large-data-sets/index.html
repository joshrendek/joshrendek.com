
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruby on Rails: Averaging Large Data Sets - Josh Rendek</title>
  <meta name="author" content="Josh Rendek">

  
  <meta name="description" content="Graphing objects client side is a great way to avoid generating them server side (since client side scales infinitely). You do however run into issue &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://joshrendek.com/2011/06/ruby-on-rails-averaging-large-data-sets">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Josh Rendek" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3754808-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">
      <span class="blue-brace">{</span>Josh Rendek<span class="blue-brace">}</span>
  </a></h1>
  
  <div class="subtitle">
  <h2>
    <span class="heart"><3</span> Ruby &amp; Go
  </h2>
  </div>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:joshrendek.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="https://devopsbyvideo.com/">Screen Casts</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/resume/">Resum√©</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="https://github.com/joshrendek">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Ruby on Rails: Averaging Large Data Sets</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-15T00:27:20-04:00" pubdate data-updated="true">Jun 15<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Graphing objects client side is a great way to avoid generating them server side (since client side scales infinitely). You do however run into issue when you get into thousands, or hundreds of thousands of points (for example displaying 5 minute intervals in a month: 8928). When graphing this many points javascript can hang or cause the browser to seem like its not responding.</p>

<p>This is a simple solution that I&rsquo;ve been using for a while to average data points from a Active Record model:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">generic_graph</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">beginning</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="ss">:hours</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="n">hours</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="no">YourModel</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;created_at &gt; ?&quot;</span><span class="p">,</span> <span class="n">beginning</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">timeoffset</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">utc_offset</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">dst?</span> <span class="p">?</span> <span class="n">timeoffset</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="c1">#or whatever number works for you</span>
      <span class="n">x</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span><span class="n">y</span><span class="o">|</span>
        <span class="n">tmp_averaged</span> <span class="o">=</span> <span class="n">x</span><span class="o">[</span><span class="n">y</span><span class="o">.</span><span class="n">.y</span><span class="o">+</span><span class="mi">24</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">ss</span><span class="o">|</span> <span class="n">ss</span><span class="o">[</span><span class="n">column</span><span class="o">]</span> <span class="p">}</span> <span class="c1"># collect 24 (or however many you want) records, then average them</span>
        <span class="n">arr</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">s</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="ss">:hours</span><span class="o">=&gt;</span><span class="n">timeoffset</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tmp_averaged</span><span class="o">.</span><span class="n">average</span><span class="o">]</span> <span class="c1"># this is for going into the flot.js graphing library</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="n">x</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">arr</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">s</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="ss">:hours</span><span class="o">=&gt;</span><span class="n">timeoffset</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">s</span><span class="o">[</span><span class="n">column</span><span class="o">]</span> <span class="o">]</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">arr</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#output for flot</span>
  <span class="k">end</span></code></pre></div>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Josh Rendek</span></span>

      








  


<time datetime="2011-06-15T00:27:20-04:00" pubdate data-updated="true">Jun 15<sup>th</sup>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://joshrendek.com/2011/06/ruby-on-rails-averaging-large-data-sets/" data-via="" data-counturl="http://joshrendek.com/2011/06/ruby-on-rails-averaging-large-data-sets/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2010/12/rails-implementing-fine-grained-acls-while-staying-dry/" title="Previous Post: Rails: Implementing fine grained ACLs while staying DRY">&laquo; Rails: Implementing fine grained ACLs while staying DRY</a>
      
      
        <a class="basic-alignment right" href="/2011/06/random-pandora-rant/" title="Next Post: Pandora's horrible interface">Pandora's horrible interface &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Projects & Software</h1>
  <ul>
    <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
    <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
    <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

    <li><a href="/projects/">View More</a>

    <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
    <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
  </ul>
</section>

<section>
  <h1>Other Blogs</h1>
  <ul>
    <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
    <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/06/building-honeypots-and-analyzing-linux-malware/">Building Honeypots and Analyzing Linux Malware</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a Distributed WaitGroup With Go and Redis</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and Ping: Sendmsg: Operation Not Permitted</a>
      </li>
    
      <li class="post">
        <a href="/2015/10/influx-alert/">Influx Alert</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/getting-upstart-to-log-to-syslog-with-tags/">Getting Upstart to Log to Syslog With Tags</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/golang-performance-tips/">Golang Performance Tips</a>
      </li>
    
  </ul>
</section>







  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Josh Rendek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluescripts';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
