
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deploying Rails With RVM in a Production Environment - Josh Rendek</title>
  <meta name="author" content="Josh Rendek">

  
  <meta name="description" content="Let&rsquo;s start out by logging into our machine and installing some pre-requistes (these can also be found by running rvm requirements as well): &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://joshrendek.com/2012/07/deploying-rails-with-rvm-in-a-production-environment">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Josh Rendek" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3754808-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">
      <span class="blue-brace">{</span>Josh Rendek<span class="blue-brace">}</span>
  </a></h1>
  
  <div class="subtitle">
  <h2>
    <span class="heart"><3</span> Ruby &amp; Go
  </h2>
  </div>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:joshrendek.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="https://devopsbyvideo.com/">Screen Casts</a></li>
  <li><a href="/categories">Categories</a></li>
  <li><a href="/resume/">Resum√©</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="https://github.com/joshrendek">Github</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deploying Rails With RVM in a Production Environment</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-26T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Let&rsquo;s start out by logging into our machine and installing some pre-requistes (these can also be found by running rvm requirements as well):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get -y install build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion git-core mysql-client libmysqlclient-dev libsasl2-dev libsasl2-dev mysql-server</code></pre></div>


<p>Lets also install nodejs:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">curl -O http://nodejs.org/dist/v0.8.4/node-v0.8.4.tar.gz
tar xzvf node-v0.8.4.tar.gz
<span class="nb">cd </span>node-v0.8.4.tar.gz 
./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> sudo make install</code></pre></div>


<p>Now we can install ruby and RVM:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">curl -L https://get.rvm.io <span class="p">|</span> bash -s stable --ruby
<span class="nb">source</span> /home/ubuntu/.rvm/scripts/rvm
rvm use 1.9.3 --default
<span class="nb">echo</span> <span class="s1">&#39;rvm_trust_rvmrcs_flag=1&#39;</span> &gt; ~/.rvmrc
<span class="c"># sudo su before this</span>
<span class="nb">echo</span> <span class="s1">&#39;RAILS_ENV=production&#39;</span> &gt;&gt; /etc/environment
rvm gemset create tester</code></pre></div>


<p>And lastly nginx:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install nginx</code></pre></div>


<p>Now let&rsquo;s make a simple rails application back on our development machine with 1 simple root action:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">rails new tester -d<span class="o">=</span>mysql
<span class="nb">echo</span> <span class="s1">&#39;rvm use 1.9.3@tester --create&#39;</span> &gt; tester/.rvmrc
<span class="nb">cd </span>tester 
bundle install
rails g controller homepage index
rm -rf public/index.html
<span class="c"># Open up config/routes.rb and modify the root to to point to homepage#index</span>
rake db:create
git init .
git remote add origin https://github.com/bluescripts/tester.git <span class="c"># replace this with your git repo</span>
git add .<span class="p">;</span> git ci -a -m <span class="s1">&#39;first&#39;</span><span class="p">;</span> git push -u origin master
rails s</code></pre></div>


<p>Open your browser and go to <a href="http://localhost:3000">http://localhost:3000</a> &ndash; all good! Now lets make some modifications to our Gemfile:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.6&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;mysql2&#39;</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.0.3&#39;</span>
<span class="k">end</span>
<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:development</span>
<span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span></code></pre></div>


<p>and re-bundle:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle</code></pre></div>


<p>Now lets start prepping for deployment and compile our assets.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">capify . 
rake assets:precompile <span class="c"># dont forget to add it to git!</span></code></pre></div>


<p>Make a file called config/unicorn.rb:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># config/unicorn.rb</span>
<span class="c1"># Set environment to development unless something else is specified</span>
<span class="n">env</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;development&quot;</span>

<span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;tester&#39;</span>
<span class="n">deploy_user</span> <span class="o">=</span> <span class="s1">&#39;ubuntu&#39;</span>

<span class="c1"># See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete</span>
<span class="c1"># documentation.</span>
<span class="n">worker_processes</span> <span class="mi">4</span>

<span class="c1"># listen on both a Unix domain socket and a TCP port,</span>
<span class="c1"># we use a shorter backlog for quicker failover when busy</span>
<span class="n">listen</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">.socket&quot;</span><span class="p">,</span> <span class="ss">:backlog</span> <span class="o">=&gt;</span> <span class="mi">64</span>

<span class="c1"># Preload our app for more speed</span>
<span class="n">preload_app</span> <span class="kp">true</span>

<span class="c1"># nuke workers after 30 seconds instead of 60 seconds (the default)</span>
<span class="n">timeout</span> <span class="mi">30</span>

<span class="n">pid</span> <span class="s2">&quot;/tmp/unicorn.</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">.pid&quot;</span>

<span class="c1"># Production specific settings</span>
<span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span>
  <span class="c1"># Help ensure your application will always spawn in the symlinked</span>
  <span class="c1"># &quot;current&quot; directory that Capistrano sets up.</span>
  <span class="n">working_directory</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">deploy_user</span><span class="si">}</span><span class="s2">/apps/</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">/current&quot;</span>

  <span class="c1"># feel free to point this anywhere accessible on the filesystem</span>
  <span class="n">shared_path</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">deploy_user</span><span class="si">}</span><span class="s2">/apps/</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">/shared&quot;</span>

  <span class="n">stderr_path</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log/unicorn.stderr.log&quot;</span>
  <span class="n">stdout_path</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log/unicorn.stdout.log&quot;</span>
<span class="k">end</span>

<span class="n">before_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
  <span class="c1"># the following is highly recomended for Rails + &quot;preload_app true&quot;</span>
  <span class="c1"># as there&#39;s no need for the master process to hold a connection</span>
  <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">disconnect!</span>
  <span class="k">end</span>

  <span class="c1"># Before forking, kill the master process that belongs to the .oldbin PID.</span>
  <span class="c1"># This enables 0 downtime deploys.</span>
  <span class="n">old_pid</span> <span class="o">=</span> <span class="s2">&quot;/tmp/unicorn.</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">.pid.oldbin&quot;</span>
  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">old_pid</span>
    <span class="k">begin</span>
      <span class="no">Process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&quot;QUIT&quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ESRCH</span>
      <span class="c1"># someone else did our job for us</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">after_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
  <span class="c1"># the following is *required* for Rails + &quot;preload_app true&quot;,</span>
  <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span>
  <span class="k">end</span>

  <span class="c1"># if preload_app is true, then you may also want to check and</span>
  <span class="c1"># restart any other shared sockets/descriptors such as Memcached,</span>
  <span class="c1"># and Redis.  TokyoCabinet file handles are safe to reuse</span>
  <span class="c1"># between any number of forked children (assuming your kernel</span>
  <span class="c1"># correctly implements pread()/pwrite() system calls)</span>
<span class="k">end</span></code></pre></div>


<p>_</p>

<p>Now lets setup the config/deploy.rb to be more unicorn and git friendly, take note of the default environment settings which are taken from the server when running rvm info <a href="http://ariejan.net/2011/09/14/lighting-fast-zero-downtime-deployments-with-git-capistrano-nginx-and-unicorn/">modified version of ariejan.net&rsquo;s</a>:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">&quot;bundler/capistrano&quot;</span>

<span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span>             <span class="ss">:git</span>
<span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span>      <span class="s2">&quot;git@github.com:bluescripts/tester.git&quot;</span>
<span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span>          <span class="s2">&quot;origin/master&quot;</span>
<span class="n">set</span> <span class="ss">:migrate_target</span><span class="p">,</span>  <span class="ss">:current</span>
<span class="n">set</span> <span class="ss">:ssh_options</span><span class="p">,</span>     <span class="p">{</span> <span class="ss">:forward_agent</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
<span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span>       <span class="s2">&quot;production&quot;</span>
<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span>       <span class="s2">&quot;/home/ubuntu/apps/tester&quot;</span>
<span class="n">set</span> <span class="ss">:normalize_asset_timestamps</span><span class="p">,</span> <span class="kp">false</span>

<span class="n">set</span> <span class="ss">:user</span><span class="p">,</span>            <span class="s2">&quot;ubuntu&quot;</span>
<span class="n">set</span> <span class="ss">:group</span><span class="p">,</span>           <span class="s2">&quot;ubuntu&quot;</span>
<span class="n">set</span> <span class="ss">:use_sudo</span><span class="p">,</span>        <span class="kp">false</span>

<span class="n">role</span> <span class="ss">:web</span><span class="p">,</span>    <span class="s2">&quot;192.168.5.113&quot;</span>
<span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>     <span class="s2">&quot;192.168.5.113&quot;</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>

<span class="n">set</span><span class="p">(</span><span class="ss">:latest_release</span><span class="p">)</span>  <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span> <span class="p">}</span>
<span class="n">set</span><span class="p">(</span><span class="ss">:release_path</span><span class="p">)</span>    <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span> <span class="p">}</span>
<span class="n">set</span><span class="p">(</span><span class="ss">:current_release</span><span class="p">)</span> <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span> <span class="p">}</span>

<span class="n">set</span><span class="p">(</span><span class="ss">:current_revision</span><span class="p">)</span>  <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git rev-parse --short HEAD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
<span class="n">set</span><span class="p">(</span><span class="ss">:latest_revision</span><span class="p">)</span>   <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git rev-parse --short HEAD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
<span class="n">set</span><span class="p">(</span><span class="ss">:previous_revision</span><span class="p">)</span> <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git rev-parse --short HEAD@{1}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>

<span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>

<span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;PATH&quot;</span><span class="o">]</span>         <span class="o">=</span> <span class="s2">&quot;/home/ubuntu/.rvm/gems/ruby-1.9.3-p194/bin:/home/ubuntu/.rvm/gems/ruby-1.9.3-p194@global/bin:/home/ubuntu/.rvm/rubies/ruby-1.9.3-p194/bin:/home/ubuntu/.rvm/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games&quot;</span>
<span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;GEM_HOME&quot;</span><span class="o">]</span>     <span class="o">=</span> <span class="s2">&quot;/home/ubuntu/.rvm/gems/ruby-1.9.3-p194&quot;</span>
<span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;GEM_PATH&quot;</span><span class="o">]</span>     <span class="o">=</span> <span class="s2">&quot;/home/ubuntu/.rvm/gems/ruby-1.9.3-p194:/home/ubuntu/.rvm/gems/ruby-1.9.3-p194@global&quot;</span>
<span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;RUBY_VERSION&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;ruby-1.9.3-p194&quot;</span>

<span class="n">default_run_options</span><span class="o">[</span><span class="ss">:shell</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bash&#39;</span>

<span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Deploy your application&quot;</span>
  <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
    <span class="n">update</span>
    <span class="n">restart</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">&quot;Setup your git-based deployment app&quot;</span>
  <span class="n">task</span> <span class="ss">:setup</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="o">[</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">shared_path</span><span class="o">]</span>
    <span class="n">dirs</span> <span class="o">+=</span> <span class="n">shared_children</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shared_path</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> mkdir -p </span><span class="si">#{</span><span class="n">dirs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &amp;&amp; </span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> chmod g+w </span><span class="si">#{</span><span class="n">dirs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">run</span> <span class="s2">&quot;git clone </span><span class="si">#{</span><span class="n">repository</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="n">task</span> <span class="ss">:cold</span> <span class="k">do</span>
    <span class="n">update</span>
    <span class="n">migrate</span>
  <span class="k">end</span>

  <span class="n">task</span> <span class="ss">:update</span> <span class="k">do</span>
    <span class="n">transaction</span> <span class="k">do</span>
      <span class="n">update_code</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">&quot;Update the deployed code.&quot;</span>
  <span class="n">task</span> <span class="ss">:update_code</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git fetch origin; git reset --hard </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">finalize_update</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">&quot;Update the database (overwritten to avoid symlink)&quot;</span>
  <span class="n">task</span> <span class="ss">:migrations</span> <span class="k">do</span>
    <span class="n">transaction</span> <span class="k">do</span>
      <span class="n">update_code</span>
    <span class="k">end</span>
    <span class="n">migrate</span>
    <span class="n">restart</span>
  <span class="k">end</span>

  <span class="n">task</span> <span class="ss">:finalize_update</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">run</span> <span class="s2">&quot;chmod -R g+w </span><span class="si">#{</span><span class="n">latest_release</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:group_writable</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>

    <span class="c1"># mkdir -p is making sure that the directories are there for some SCM&#39;s that don&#39;t</span>
    <span class="c1"># save empty folders</span>
    <span class="n">run</span> <span class="o">&lt;&lt;-</span><span class="no">CMD</span>
<span class="sh">      rm -rf #{latest_release}/log #{latest_release}/public/system #{latest_release}/tmp/pids &amp;&amp;</span>
<span class="sh">      mkdir -p #{latest_release}/public &amp;&amp;</span>
<span class="sh">      mkdir -p #{latest_release}/tmp &amp;&amp;</span>
<span class="sh">      ln -s #{shared_path}/log #{latest_release}/log &amp;&amp;</span>
<span class="sh">      ln -s #{shared_path}/system #{latest_release}/public/system &amp;&amp;</span>
<span class="sh">      ln -s #{shared_path}/pids #{latest_release}/tmp/pids &amp;&amp;</span>
<span class="sh">      ln -sf #{shared_path}/database.yml #{latest_release}/config/database.yml</span>
<span class="no">    CMD</span>

    <span class="k">if</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:normalize_asset_timestamps</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
      <span class="n">stamp</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m%d%H%M.%S&quot;</span><span class="p">)</span>
      <span class="n">asset_paths</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:public_children</span><span class="p">,</span> <span class="sx">%w(images stylesheets javascripts)</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">latest_release</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
      <span class="n">run</span> <span class="s2">&quot;find </span><span class="si">#{</span><span class="n">asset_paths</span><span class="si">}</span><span class="s2"> -exec touch -t </span><span class="si">#{</span><span class="n">stamp</span><span class="si">}</span><span class="s2"> {} &#39;;&#39;; true&quot;</span><span class="p">,</span> <span class="ss">:env</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;TZ&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;UTC&quot;</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">&quot;Zero-downtime restart of Unicorn&quot;</span>
  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">run</span> <span class="s2">&quot;kill -s USR2 `cat /tmp/unicorn.tester.pid`&quot;</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">&quot;Start unicorn&quot;</span>
  <span class="n">task</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> ; bundle exec unicorn_rails -c config/unicorn.rb -D&quot;</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">&quot;Stop unicorn&quot;</span>
  <span class="n">task</span> <span class="ss">:stop</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">run</span> <span class="s2">&quot;kill -s QUIT `cat /tmp/unicorn.tester.pid`&quot;</span>
  <span class="k">end</span>  

  <span class="n">namespace</span> <span class="ss">:rollback</span> <span class="k">do</span>
    <span class="n">desc</span> <span class="s2">&quot;Moves the repo back to the previous version of HEAD&quot;</span>
    <span class="n">task</span> <span class="ss">:repo</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;HEAD@{1}&quot;</span>
      <span class="n">deploy</span><span class="o">.</span><span class="n">default</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="s2">&quot;Rewrite reflog so HEAD@{1} will continue to point to at the next previous release.&quot;</span>
    <span class="n">task</span> <span class="ss">:cleanup</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git reflog delete --rewrite HEAD@{1}; git reflog delete --rewrite HEAD@{1}&quot;</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="s2">&quot;Rolls back to the previously deployed version.&quot;</span>
    <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
      <span class="n">rollback</span><span class="o">.</span><span class="n">repo</span>
      <span class="n">rollback</span><span class="o">.</span><span class="n">cleanup</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">run_rake</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; </span><span class="si">#{</span><span class="n">rake</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></code></pre></div>


<p>Now lets try deploying (you may need to login to the server if this is the first time you&rsquo;ve cloned from git to accept the SSH handshake):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cap deploy:setup</code></pre></div>


<p>Create your database config file in shared/database.yml:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql2</span>
  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
  <span class="l-Scalar-Plain">reconnect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tester_production</span>
  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span></code></pre></div>


<p>_</p>

<p>Go into current and create the database if you haven&rsquo;t already:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">rake db:create 
<span class="c"># cd down a level </span>
<span class="nb">cd</span> ../ 
mkdir -p shared/pids</code></pre></div>


<p>Now we can run the cold deploy:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cap deploy:cold
cap deploy:start</code></pre></div>


<p>Now we can configure nginx:</p>

<p>Open up /etc/nginx/sites-enabled/default:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">upstream tester <span class="o">{</span>
    server unix:/tmp/tester.socket <span class="nv">fail_timeout</span><span class="o">=</span>0<span class="p">;</span>
<span class="o">}</span>
server <span class="o">{</span>
    listen <span class="m">80</span> default<span class="p">;</span>
    root /home/ubuntu/apps/tester/current/public<span class="p">;</span>
    location / <span class="o">{</span> 
        proxy_pass  http://tester<span class="p">;</span>
        proxy_redirect     off<span class="p">;</span>

        proxy_set_header   Host             <span class="nv">$host</span><span class="p">;</span>
        proxy_set_header   X-Real-IP        <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header   X-Forwarded-For  <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>

        client_max_body_size       10m<span class="p">;</span>
        client_body_buffer_size    128k<span class="p">;</span>

        proxy_connect_timeout      90<span class="p">;</span>
        proxy_send_timeout         90<span class="p">;</span>
        proxy_read_timeout         90<span class="p">;</span>

        proxy_buffer_size          4k<span class="p">;</span>
        proxy_buffers              <span class="m">4</span> 32k<span class="p">;</span>
        proxy_busy_buffers_size    64k<span class="p">;</span>
        proxy_temp_file_write_size 64k<span class="p">;</span>
    <span class="o">}</span>

    location ~ ^/<span class="o">(</span>images<span class="p">|</span>javascripts<span class="p">|</span>stylesheets<span class="p">|</span>system<span class="p">|</span>assets<span class="o">)</span>/  <span class="o">{</span>
        root /home/deployer/apps/my_site/current/public<span class="p">;</span>
        expires max<span class="p">;</span>
        <span class="nb">break</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>


<p>Now restart nginx and visit <a href="http://192.168.5.113/">http://192.168.5.113/</a> ( replace with your server hostname/IP ). You should be all set!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Josh Rendek</span></span>

      








  


<time datetime="2012-07-26T00:00:00-04:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://joshrendek.com/2012/07/deploying-rails-with-rvm-in-a-production-environment/" data-via="" data-counturl="http://joshrendek.com/2012/07/deploying-rails-with-rvm-in-a-production-environment/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/07/the-problem-with-pingdom/" title="Previous Post: The problem with Pingdom">&laquo; The problem with Pingdom</a>
      
      
        <a class="basic-alignment right" href="/2012/07/upgrading/" title="Next Post: Upgrading to Mountain Lion and fixing your development environment">Upgrading to Mountain Lion and fixing your development environment &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Projects & Software</h1>
  <ul>
    <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
    <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
    <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

    <li><a href="/projects/">View More</a>

    <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
    <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
  </ul>
</section>

<section>
  <h1>Other Blogs</h1>
  <ul>
    <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
    <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/06/building-honeypots-and-analyzing-linux-malware/">Building Honeypots and Analyzing Linux Malware</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a Distributed WaitGroup With Go and Redis</a>
      </li>
    
      <li class="post">
        <a href="/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and Ping: Sendmsg: Operation Not Permitted</a>
      </li>
    
      <li class="post">
        <a href="/2015/10/influx-alert/">Influx Alert</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/getting-upstart-to-log-to-syslog-with-tags/">Getting Upstart to Log to Syslog With Tags</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/golang-performance-tips/">Golang Performance Tips</a>
      </li>
    
  </ul>
</section>







  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Josh Rendek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bluescripts';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
