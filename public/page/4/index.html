<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.25.1" />

<meta property="og:title" content="Josh Rendek" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://joshrendek.com/" />



<meta property="og:updated_time" content="2012-08-16T00:00:00&#43;00:00"/>













<meta itemprop="name" content="Josh Rendek">
<meta itemprop="description" content="">



<link rel="stylesheet" type="text/css" href="/css/layout.css" />
<link rel="stylesheet" type="text/css" href="/css/pygments.css" />
<link rel="stylesheet" type="text/css" href="/css/color-dark.css" />


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-3754808-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


<title>


    Josh Rendek

</title>

<script src="/js/highlight.min.js"></script>
<link rel="stylesheet" href="/css/tomorrow-night.min.css" />
<script>hljs.initHighlightingOnLoad();</script>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://joshrendek.com">
        <span class='blue-brace'>{</span>
        Josh Rendek
        <span class='blue-brace'>}</span>
      </a>
      <div class="header-subtitle">
        <h2>
          <span class="heart">&lt;3</span> Ruby &amp; Go
        </h2>
      </div>
    </div> 
  </nav>
  <nav>
      
      
      <a class="nav-item active" href="/"><div class="nav-item-title">Home</div></a>
      
      <a class="nav-item" href="/projects/"><div class="nav-item-title">Projects</div></a>
      
      <a class="nav-item" href="/archives/"><div class="nav-item-title">Archives</div></a>
      
      <a class="nav-item" href="https://devopsbyvideo.com/"><div class="nav-item-title">Screen Casts</div></a>
      
      <a class="nav-item" href="/about/"><div class="nav-item-title">About</div></a>
      
      <a class="nav-item" href="/categories/"><div class="nav-item-title">Categories</div></a>
      
      <a class="nav-item" href="https://github.com/joshrendek/"><div class="nav-item-title">GitHub</div></a>
      
      <a class="nav-item" href="/resume.pdf"><div class="nav-item-title">Resume</div></a>
      
   </nav>
</div>

  
<div class="social-links-header">

  

  

  

  

  

</div>


</header>


<main>
  <div class="articles">
    
    
    <article class="post">
      <div class="date"> Aug 16, 2012 - 1 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/08/never-set-instance-variables-again/'> Never Set Instance Variables Again</a> </h1>
      <div class="content"> <p>Tired of doing this on every method in ruby?
{% codeblock lang:ruby %}
class Person
    def initialize(name)
        @name = name
    end
end
{% endcodeblock %}</p>

<p>Use the awesome power of ruby and metaprogramming to auto set method paramters to instance variables:</p>

<p>{% codeblock lang:ruby %}
class Person
    def initialize(name)
        method(<strong>method</strong>).parameters.collect {|x| instance_variable_set(&ldquo;@#{x[1]}&ldquo;, eval(x[1].to_s)) }
    end
end
{% endcodeblock %}</p>

<p>Now you can access your parameters being passed in as instance variables for an object. You can extract this out into a method to apply to all objects or just make a simple extension to include it in files that you wanted to use it in. While this is a trivial example, for methods with longer signatures this becomes a more appealing approach. I&rsquo;ll probably extract this out into a gem and post it here later.</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Jul 31, 2012 - 1 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/07/upgrading/'> Upgrading to Mountain Lion and fixing your development environment</a> </h1>
      <div class="content"> <p>Upgrading to OSX Mountain Lion:</p>

<ul>
<li>Download and install the Mountain Lion Command Line Tools</li>
<li>Download and install the <a href="https://github.com/kennethreitz/osx-gcc-installer/downloads/">https://github.com/kennethreitz/osx-gcc-installer/downloads/</a> CLI tools for gcc (no</li>
<li>Download and install XQuartz</li>
</ul>

<p>Run:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>brew update
<span class="lineno">2 </span>brew link autoconf <span class="c"># optional, not always needed</span>
<span class="lineno">3 </span>brew install automake <span class="c"># optional, not always needed</span>
<span class="lineno">4 </span>brew upgrade
<span class="lineno">5 </span>rvm reinstall 1.9.3 --patch falcon
</code></pre></div>
</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Jul 26, 2012 - 8 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/07/deploying-rails-with-rvm-in-a-production-environment/'> Deploying Rails with RVM in a production environment</a> </h1>
      <div class="content"> <p>Let&rsquo;s start out by logging into our machine and installing some pre-requistes (these can also be found by running rvm requirements as well):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>sudo apt-get -y install build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion git-core mysql-client libmysqlclient-dev libsasl2-dev libsasl2-dev mysql-server
</code></pre></div>


<p>Lets also install nodejs:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>curl -O http://nodejs.org/dist/v0.8.4/node-v0.8.4.tar.gz
<span class="lineno">2 </span>tar xzvf node-v0.8.4.tar.gz
<span class="lineno">3 </span><span class="nb">cd </span>node-v0.8.4.tar.gz
<span class="lineno">4 </span>./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> sudo make install
</code></pre></div>
</p>

<p>Now we can install ruby and RVM:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>curl -L https://get.rvm.io <span class="p">|</span> bash -s stable --ruby
<span class="lineno">2 </span><span class="nb">source</span> /home/ubuntu/.rvm/scripts/rvm
<span class="lineno">3 </span>rvm use 1.9.3 --default
<span class="lineno">4 </span><span class="nb">echo</span> <span class="s1">&#39;rvm_trust_rvmrcs_flag=1&#39;</span> &gt; ~/.rvmrc
<span class="lineno">5 </span><span class="c"># sudo su before this</span>
<span class="lineno">6 </span><span class="nb">echo</span> <span class="s1">&#39;RAILS_ENV=production&#39;</span> &gt;&gt; /etc/environment
<span class="lineno">7 </span>rvm gemset create tester
</code></pre></div>
</p>

<p>And lastly nginx:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>sudo apt-get install nginx
</code></pre></div>
</p>

<p>Now let&rsquo;s make a simple rails application back on our development machine with 1 simple root action:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno"> 1 </span>rails new tester -d<span class="o">=</span>mysql
<span class="lineno"> 2 </span><span class="nb">echo</span> <span class="s1">&#39;rvm use 1.9.3@tester --create&#39;</span> &gt; tester/.rvmrc
<span class="lineno"> 3 </span><span class="nb">cd </span>tester
<span class="lineno"> 4 </span>bundle install
<span class="lineno"> 5 </span>rails g controller homepage index
<span class="lineno"> 6 </span>rm -rf public/index.html
<span class="lineno"> 7 </span><span class="c"># Open up config/routes.rb and modify the root to to point to homepage#index</span>
<span class="lineno"> 8 </span>rake db:create
<span class="lineno"> 9 </span>git init .
<span class="lineno">10 </span>git remote add origin https://github.com/bluescripts/tester.git <span class="c"># replace this with your git repo</span>
<span class="lineno">11 </span>git add .<span class="p">;</span> git ci -a -m <span class="s1">&#39;first&#39;</span><span class="p">;</span> git push -u origin master
<span class="lineno">12 </span>rails s
</code></pre></div>
</p>

<p>Open your browser and go to <a href="http://localhost:3000">http://localhost:3000</a> &ndash; all good! Now lets make some modifications to our Gemfile:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1 </span><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="lineno"> 2 </span><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.6&#39;</span>
<span class="lineno"> 3 </span><span class="n">gem</span> <span class="s1">&#39;mysql2&#39;</span>
<span class="lineno"> 4 </span><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
<span class="lineno"> 5 </span>  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
<span class="lineno"> 6 </span>  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.1&#39;</span>
<span class="lineno"> 7 </span>  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.0.3&#39;</span>
<span class="lineno"> 8 </span><span class="k">end</span>
<span class="lineno"> 9 </span><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>
<span class="lineno">10 </span><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:development</span>
<span class="lineno">11 </span><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
</code></pre></div>


<p>and re-bundle:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span> bundle 
</code></pre></div>
</p>

<p>Now lets start prepping for deployment and compile our assets.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>capify .
<span class="lineno">2 </span>rake assets:precompile <span class="c"># dont forget to add it to git!</span>
</code></pre></div>


<p>Make a file called config/unicorn.rb:
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1 </span><span class="c1"># config/unicorn.rb</span>
<span class="lineno"> 2 </span><span class="c1"># Set environment to development unless something else is specified</span>
<span class="lineno"> 3 </span><span class="n">env</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;development&quot;</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;tester&#39;</span>
<span class="lineno"> 6 </span><span class="n">deploy_user</span> <span class="o">=</span> <span class="s1">&#39;ubuntu&#39;</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c1"># See http://unicorn.bogomips.org/Unicorn/Configurator.html for complete</span>
<span class="lineno"> 9 </span><span class="c1"># documentation.</span>
<span class="lineno">10 </span><span class="n">worker_processes</span> <span class="mi">4</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="c1"># listen on both a Unix domain socket and a TCP port,</span>
<span class="lineno">13 </span><span class="c1"># we use a shorter backlog for quicker failover when busy</span>
<span class="lineno">14 </span><span class="n">listen</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">.socket&quot;</span><span class="p">,</span> <span class="ss">:backlog</span> <span class="o">=&gt;</span> <span class="mi">64</span>
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="c1"># Preload our app for more speed</span>
<span class="lineno">17 </span><span class="n">preload_app</span> <span class="kp">true</span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="c1"># nuke workers after 30 seconds instead of 60 seconds (the default)</span>
<span class="lineno">20 </span><span class="n">timeout</span> <span class="mi">30</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span><span class="n">pid</span> <span class="s2">&quot;/tmp/unicorn.</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">.pid&quot;</span>
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># Production specific settings</span>
<span class="lineno">25 </span><span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span>
<span class="lineno">26 </span>  <span class="c1"># Help ensure your application will always spawn in the symlinked</span>
<span class="lineno">27 </span>  <span class="c1"># &quot;current&quot; directory that Capistrano sets up.</span>
<span class="lineno">28 </span>  <span class="n">working_directory</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">deploy_user</span><span class="si">}</span><span class="s2">/apps/</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">/current&quot;</span>
<span class="lineno">29 </span>
<span class="lineno">30 </span>  <span class="c1"># feel free to point this anywhere accessible on the filesystem</span>
<span class="lineno">31 </span>  <span class="n">shared_path</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">deploy_user</span><span class="si">}</span><span class="s2">/apps/</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">/shared&quot;</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span>  <span class="n">stderr_path</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log/unicorn.stderr.log&quot;</span>
<span class="lineno">34 </span>  <span class="n">stdout_path</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log/unicorn.stdout.log&quot;</span>
<span class="lineno">35 </span><span class="k">end</span>
<span class="lineno">36 </span>
<span class="lineno">37 </span><span class="n">before_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
<span class="lineno">38 </span>  <span class="c1"># the following is highly recomended for Rails + &quot;preload_app true&quot;</span>
<span class="lineno">39 </span>  <span class="c1"># as there&#39;s no need for the master process to hold a connection</span>
<span class="lineno">40 </span>  <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span>
<span class="lineno">41 </span>    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">disconnect!</span>
<span class="lineno">42 </span>  <span class="k">end</span>
<span class="lineno">43 </span>
<span class="lineno">44 </span>  <span class="c1"># Before forking, kill the master process that belongs to the .oldbin PID.</span>
<span class="lineno">45 </span>  <span class="c1"># This enables 0 downtime deploys.</span>
<span class="lineno">46 </span>  <span class="n">old_pid</span> <span class="o">=</span> <span class="s2">&quot;/tmp/unicorn.</span><span class="si">#{</span><span class="n">site</span><span class="si">}</span><span class="s2">.pid.oldbin&quot;</span>
<span class="lineno">47 </span>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">old_pid</span>
<span class="lineno">48 </span>    <span class="k">begin</span>
<span class="lineno">49 </span>      <span class="no">Process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&quot;QUIT&quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
<span class="lineno">50 </span>    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ESRCH</span>
<span class="lineno">51 </span>      <span class="c1"># someone else did our job for us</span>
<span class="lineno">52 </span>    <span class="k">end</span>
<span class="lineno">53 </span>  <span class="k">end</span>
<span class="lineno">54 </span><span class="k">end</span>
<span class="lineno">55 </span>
<span class="lineno">56 </span><span class="n">after_fork</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="p">,</span> <span class="n">worker</span><span class="o">|</span>
<span class="lineno">57 </span>  <span class="c1"># the following is *required* for Rails + &quot;preload_app true&quot;,</span>
<span class="lineno">58 </span>  <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span>
<span class="lineno">59 </span>    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span>
<span class="lineno">60 </span>  <span class="k">end</span>
<span class="lineno">61 </span>
<span class="lineno">62 </span>  <span class="c1"># if preload_app is true, then you may also want to check and</span>
<span class="lineno">63 </span>  <span class="c1"># restart any other shared sockets/descriptors such as Memcached,</span>
<span class="lineno">64 </span>  <span class="c1"># and Redis.  TokyoCabinet file handles are safe to reuse</span>
<span class="lineno">65 </span>  <span class="c1"># between any number of forked children (assuming your kernel</span>
<span class="lineno">66 </span>  <span class="c1"># correctly implements pread()/pwrite() system calls)</span>
<span class="lineno">67 </span><span class="k">end</span>
</code></pre></div>

_</p>

<p>Now lets setup the config/deploy.rb to be more unicorn and git friendly, take note of the default environment settings which are taken from the server when running rvm info <a href="http://ariejan.net/2011/09/14/lighting-fast-zero-downtime-deployments-with-git-capistrano-nginx-and-unicorn/">modified version of ariejan.net&rsquo;s</a>:</p>

<p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">  1 </span><span class="nb">require</span> <span class="s2">&quot;bundler/capistrano&quot;</span>
<span class="lineno">  2 </span>
<span class="lineno">  3 </span><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span>             <span class="ss">:git</span>
<span class="lineno">  4 </span><span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span>      <span class="s2">&quot;git@github.com:bluescripts/tester.git&quot;</span>
<span class="lineno">  5 </span><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span>          <span class="s2">&quot;origin/master&quot;</span>
<span class="lineno">  6 </span><span class="n">set</span> <span class="ss">:migrate_target</span><span class="p">,</span>  <span class="ss">:current</span>
<span class="lineno">  7 </span><span class="n">set</span> <span class="ss">:ssh_options</span><span class="p">,</span>     <span class="p">{</span> <span class="ss">:forward_agent</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
<span class="lineno">  8 </span><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span>       <span class="s2">&quot;production&quot;</span>
<span class="lineno">  9 </span><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span>       <span class="s2">&quot;/home/ubuntu/apps/tester&quot;</span>
<span class="lineno"> 10 </span><span class="n">set</span> <span class="ss">:normalize_asset_timestamps</span><span class="p">,</span> <span class="kp">false</span>
<span class="lineno"> 11 </span>
<span class="lineno"> 12 </span><span class="n">set</span> <span class="ss">:user</span><span class="p">,</span>            <span class="s2">&quot;ubuntu&quot;</span>
<span class="lineno"> 13 </span><span class="n">set</span> <span class="ss">:group</span><span class="p">,</span>           <span class="s2">&quot;ubuntu&quot;</span>
<span class="lineno"> 14 </span><span class="n">set</span> <span class="ss">:use_sudo</span><span class="p">,</span>        <span class="kp">false</span>
<span class="lineno"> 15 </span>
<span class="lineno"> 16 </span><span class="n">role</span> <span class="ss">:web</span><span class="p">,</span>    <span class="s2">&quot;192.168.5.113&quot;</span>
<span class="lineno"> 17 </span><span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>     <span class="s2">&quot;192.168.5.113&quot;</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="lineno"> 18 </span>
<span class="lineno"> 19 </span><span class="n">set</span><span class="p">(</span><span class="ss">:latest_release</span><span class="p">)</span>  <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span> <span class="p">}</span>
<span class="lineno"> 20 </span><span class="n">set</span><span class="p">(</span><span class="ss">:release_path</span><span class="p">)</span>    <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span> <span class="p">}</span>
<span class="lineno"> 21 </span><span class="n">set</span><span class="p">(</span><span class="ss">:current_release</span><span class="p">)</span> <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span> <span class="p">}</span>
<span class="lineno"> 22 </span>
<span class="lineno"> 23 </span><span class="n">set</span><span class="p">(</span><span class="ss">:current_revision</span><span class="p">)</span>  <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git rev-parse --short HEAD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
<span class="lineno"> 24 </span><span class="n">set</span><span class="p">(</span><span class="ss">:latest_revision</span><span class="p">)</span>   <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git rev-parse --short HEAD&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
<span class="lineno"> 25 </span><span class="n">set</span><span class="p">(</span><span class="ss">:previous_revision</span><span class="p">)</span> <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git rev-parse --short HEAD@{1}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
<span class="lineno"> 26 </span>
<span class="lineno"> 27 </span><span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
<span class="lineno"> 28 </span>
<span class="lineno"> 29 </span><span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;PATH&quot;</span><span class="o">]</span>         <span class="o">=</span> <span class="s2">&quot;/home/ubuntu/.rvm/gems/ruby-1.9.3-p194/bin:/home/ubuntu/.rvm/gems/ruby-1.9.3-p194@global/bin:/home/ubuntu/.rvm/rubies/ruby-1.9.3-p194/bin:/home/ubuntu/.rvm/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games&quot;</span>
<span class="lineno"> 30 </span><span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;GEM_HOME&quot;</span><span class="o">]</span>     <span class="o">=</span> <span class="s2">&quot;/home/ubuntu/.rvm/gems/ruby-1.9.3-p194&quot;</span>
<span class="lineno"> 31 </span><span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;GEM_PATH&quot;</span><span class="o">]</span>     <span class="o">=</span> <span class="s2">&quot;/home/ubuntu/.rvm/gems/ruby-1.9.3-p194:/home/ubuntu/.rvm/gems/ruby-1.9.3-p194@global&quot;</span>
<span class="lineno"> 32 </span><span class="n">default_environment</span><span class="o">[</span><span class="s2">&quot;RUBY_VERSION&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;ruby-1.9.3-p194&quot;</span>
<span class="lineno"> 33 </span>
<span class="lineno"> 34 </span><span class="n">default_run_options</span><span class="o">[</span><span class="ss">:shell</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;bash&#39;</span>
<span class="lineno"> 35 </span>
<span class="lineno"> 36 </span><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
<span class="lineno"> 37 </span>  <span class="n">desc</span> <span class="s2">&quot;Deploy your application&quot;</span>
<span class="lineno"> 38 </span>  <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
<span class="lineno"> 39 </span>    <span class="n">update</span>
<span class="lineno"> 40 </span>    <span class="n">restart</span>
<span class="lineno"> 41 </span>  <span class="k">end</span>
<span class="lineno"> 42 </span>
<span class="lineno"> 43 </span>  <span class="n">desc</span> <span class="s2">&quot;Setup your git-based deployment app&quot;</span>
<span class="lineno"> 44 </span>  <span class="n">task</span> <span class="ss">:setup</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno"> 45 </span>    <span class="n">dirs</span> <span class="o">=</span> <span class="o">[</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">shared_path</span><span class="o">]</span>
<span class="lineno"> 46 </span>    <span class="n">dirs</span> <span class="o">+=</span> <span class="n">shared_children</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shared_path</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="p">}</span>
<span class="lineno"> 47 </span>    <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> mkdir -p </span><span class="si">#{</span><span class="n">dirs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &amp;&amp; </span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> chmod g+w </span><span class="si">#{</span><span class="n">dirs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno"> 48 </span>    <span class="n">run</span> <span class="s2">&quot;git clone </span><span class="si">#{</span><span class="n">repository</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno"> 49 </span>  <span class="k">end</span>
<span class="lineno"> 50 </span>
<span class="lineno"> 51 </span>  <span class="n">task</span> <span class="ss">:cold</span> <span class="k">do</span>
<span class="lineno"> 52 </span>    <span class="n">update</span>
<span class="lineno"> 53 </span>    <span class="n">migrate</span>
<span class="lineno"> 54 </span>  <span class="k">end</span>
<span class="lineno"> 55 </span>
<span class="lineno"> 56 </span>  <span class="n">task</span> <span class="ss">:update</span> <span class="k">do</span>
<span class="lineno"> 57 </span>    <span class="n">transaction</span> <span class="k">do</span>
<span class="lineno"> 58 </span>      <span class="n">update_code</span>
<span class="lineno"> 59 </span>    <span class="k">end</span>
<span class="lineno"> 60 </span>  <span class="k">end</span>
<span class="lineno"> 61 </span>
<span class="lineno"> 62 </span>  <span class="n">desc</span> <span class="s2">&quot;Update the deployed code.&quot;</span>
<span class="lineno"> 63 </span>  <span class="n">task</span> <span class="ss">:update_code</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno"> 64 </span>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git fetch origin; git reset --hard </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno"> 65 </span>    <span class="n">finalize_update</span>
<span class="lineno"> 66 </span>  <span class="k">end</span>
<span class="lineno"> 67 </span>
<span class="lineno"> 68 </span>  <span class="n">desc</span> <span class="s2">&quot;Update the database (overwritten to avoid symlink)&quot;</span>
<span class="lineno"> 69 </span>  <span class="n">task</span> <span class="ss">:migrations</span> <span class="k">do</span>
<span class="lineno"> 70 </span>    <span class="n">transaction</span> <span class="k">do</span>
<span class="lineno"> 71 </span>      <span class="n">update_code</span>
<span class="lineno"> 72 </span>    <span class="k">end</span>
<span class="lineno"> 73 </span>    <span class="n">migrate</span>
<span class="lineno"> 74 </span>    <span class="n">restart</span>
<span class="lineno"> 75 </span>  <span class="k">end</span>
<span class="lineno"> 76 </span>
<span class="lineno"> 77 </span>  <span class="n">task</span> <span class="ss">:finalize_update</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno"> 78 </span>    <span class="n">run</span> <span class="s2">&quot;chmod -R g+w </span><span class="si">#{</span><span class="n">latest_release</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:group_writable</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
<span class="lineno"> 79 </span>
<span class="lineno"> 80 </span>    <span class="c1"># mkdir -p is making sure that the directories are there for some SCM&#39;s that don&#39;t</span>
<span class="lineno"> 81 </span>    <span class="c1"># save empty folders</span>
<span class="lineno"> 82 </span>    <span class="n">run</span> <span class="o">&lt;&lt;-</span><span class="no">CMD</span>
<span class="lineno"> 83 </span><span class="sh">      rm -rf #{latest_release}/log #{latest_release}/public/system #{latest_release}/tmp/pids &amp;&amp;</span>
<span class="lineno"> 84 </span><span class="sh">      mkdir -p #{latest_release}/public &amp;&amp;</span>
<span class="lineno"> 85 </span><span class="sh">      mkdir -p #{latest_release}/tmp &amp;&amp;</span>
<span class="lineno"> 86 </span><span class="sh">      ln -s #{shared_path}/log #{latest_release}/log &amp;&amp;</span>
<span class="lineno"> 87 </span><span class="sh">      ln -s #{shared_path}/system #{latest_release}/public/system &amp;&amp;</span>
<span class="lineno"> 88 </span><span class="sh">      ln -s #{shared_path}/pids #{latest_release}/tmp/pids &amp;&amp;</span>
<span class="lineno"> 89 </span><span class="sh">      ln -sf #{shared_path}/database.yml #{latest_release}/config/database.yml</span>
<span class="lineno"> 90 </span><span class="no">    CMD</span>
<span class="lineno"> 91 </span>
<span class="lineno"> 92 </span>    <span class="k">if</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:normalize_asset_timestamps</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
<span class="lineno"> 93 </span>      <span class="n">stamp</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m%d%H%M.%S&quot;</span><span class="p">)</span>
<span class="lineno"> 94 </span>      <span class="n">asset_paths</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:public_children</span><span class="p">,</span> <span class="sx">%w(images stylesheets javascripts)</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">latest_release</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="lineno"> 95 </span>      <span class="n">run</span> <span class="s2">&quot;find </span><span class="si">#{</span><span class="n">asset_paths</span><span class="si">}</span><span class="s2"> -exec touch -t </span><span class="si">#{</span><span class="n">stamp</span><span class="si">}</span><span class="s2"> {} &#39;;&#39;; true&quot;</span><span class="p">,</span> <span class="ss">:env</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;TZ&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;UTC&quot;</span> <span class="p">}</span>
<span class="lineno"> 96 </span>    <span class="k">end</span>
<span class="lineno"> 97 </span>  <span class="k">end</span>
<span class="lineno"> 98 </span>
<span class="lineno"> 99 </span>  <span class="n">desc</span> <span class="s2">&quot;Zero-downtime restart of Unicorn&quot;</span>
<span class="lineno">100 </span>  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno">101 </span>    <span class="n">run</span> <span class="s2">&quot;kill -s USR2 `cat /tmp/unicorn.tester.pid`&quot;</span>
<span class="lineno">102 </span>  <span class="k">end</span>
<span class="lineno">103 </span>
<span class="lineno">104 </span>  <span class="n">desc</span> <span class="s2">&quot;Start unicorn&quot;</span>
<span class="lineno">105 </span>  <span class="n">task</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno">106 </span>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> ; bundle exec unicorn_rails -c config/unicorn.rb -D&quot;</span>
<span class="lineno">107 </span>  <span class="k">end</span>
<span class="lineno">108 </span>
<span class="lineno">109 </span>  <span class="n">desc</span> <span class="s2">&quot;Stop unicorn&quot;</span>
<span class="lineno">110 </span>  <span class="n">task</span> <span class="ss">:stop</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno">111 </span>    <span class="n">run</span> <span class="s2">&quot;kill -s QUIT `cat /tmp/unicorn.tester.pid`&quot;</span>
<span class="lineno">112 </span>  <span class="k">end</span>
<span class="lineno">113 </span>
<span class="lineno">114 </span>  <span class="n">namespace</span> <span class="ss">:rollback</span> <span class="k">do</span>
<span class="lineno">115 </span>    <span class="n">desc</span> <span class="s2">&quot;Moves the repo back to the previous version of HEAD&quot;</span>
<span class="lineno">116 </span>    <span class="n">task</span> <span class="ss">:repo</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno">117 </span>      <span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;HEAD@{1}&quot;</span>
<span class="lineno">118 </span>      <span class="n">deploy</span><span class="o">.</span><span class="n">default</span>
<span class="lineno">119 </span>    <span class="k">end</span>
<span class="lineno">120 </span>
<span class="lineno">121 </span>    <span class="n">desc</span> <span class="s2">&quot;Rewrite reflog so HEAD@{1} will continue to point to at the next previous release.&quot;</span>
<span class="lineno">122 </span>    <span class="n">task</span> <span class="ss">:cleanup</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
<span class="lineno">123 </span>      <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; git reflog delete --rewrite HEAD@{1}; git reflog delete --rewrite HEAD@{1}&quot;</span>
<span class="lineno">124 </span>    <span class="k">end</span>
<span class="lineno">125 </span>
<span class="lineno">126 </span>    <span class="n">desc</span> <span class="s2">&quot;Rolls back to the previously deployed version.&quot;</span>
<span class="lineno">127 </span>    <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
<span class="lineno">128 </span>      <span class="n">rollback</span><span class="o">.</span><span class="n">repo</span>
<span class="lineno">129 </span>      <span class="n">rollback</span><span class="o">.</span><span class="n">cleanup</span>
<span class="lineno">130 </span>    <span class="k">end</span>
<span class="lineno">131 </span>  <span class="k">end</span>
<span class="lineno">132 </span><span class="k">end</span>
<span class="lineno">133 </span>
<span class="lineno">134 </span><span class="k">def</span> <span class="nf">run_rake</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="lineno">135 </span>  <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; </span><span class="si">#{</span><span class="n">rake</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">136 </span><span class="k">end</span>
</code></pre></div>
</p>

<p>Now lets try deploying (you may need to login to the server if this is the first time you&rsquo;ve cloned from git to accept the SSH handshake):
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>cap deploy:setup
</code></pre></div>
</p>

<p>Create your database config file in shared/database.yml:
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno">1 </span><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
<span class="lineno">2 </span>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql2</span>
<span class="lineno">3 </span>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
<span class="lineno">4 </span>  <span class="l-Scalar-Plain">reconnect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
<span class="lineno">5 </span>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tester_production</span>
<span class="lineno">6 </span>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
<span class="lineno">7 </span>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
<span class="lineno">8 </span>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>
</code></pre></div>

_</p>

<p>Go into current and create the database if you haven&rsquo;t already:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>rake db:create
<span class="lineno">2 </span><span class="c"># cd down a level</span>
<span class="lineno">3 </span><span class="nb">cd</span> ../
<span class="lineno">4 </span>mkdir -p shared/pids
</code></pre></div>
</p>

<p>Now we can run the cold deploy:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>cap deploy:cold
<span class="lineno">2 </span>cap deploy:start
</code></pre></div>


<p>Now we can configure nginx:</p>

<p>Open up /etc/nginx/sites-enabled/default:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno"> 1 </span>upstream tester <span class="o">{</span>
<span class="lineno"> 2 </span>	server unix:/tmp/tester.socket <span class="nv">fail_timeout</span><span class="o">=</span>0<span class="p">;</span>
<span class="lineno"> 3 </span><span class="o">}</span>
<span class="lineno"> 4 </span>server <span class="o">{</span>
<span class="lineno"> 5 </span>	listen <span class="m">80</span> default<span class="p">;</span>
<span class="lineno"> 6 </span> 	root /home/ubuntu/apps/tester/current/public<span class="p">;</span>
<span class="lineno"> 7 </span>	location / <span class="o">{</span>
<span class="lineno"> 8 </span>		proxy_pass  http://tester<span class="p">;</span>
<span class="lineno"> 9 </span>		proxy_redirect     off<span class="p">;</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span>		proxy_set_header   Host             <span class="nv">$host</span><span class="p">;</span>
<span class="lineno">12 </span>		proxy_set_header   X-Real-IP        <span class="nv">$remote_addr</span><span class="p">;</span>
<span class="lineno">13 </span>		proxy_set_header   X-Forwarded-For  <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span>		client_max_body_size       10m<span class="p">;</span>
<span class="lineno">16 </span>		client_body_buffer_size    128k<span class="p">;</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span>		proxy_connect_timeout      90<span class="p">;</span>
<span class="lineno">19 </span>		proxy_send_timeout         90<span class="p">;</span>
<span class="lineno">20 </span>		proxy_read_timeout         90<span class="p">;</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span>		proxy_buffer_size          4k<span class="p">;</span>
<span class="lineno">23 </span>		proxy_buffers              <span class="m">4</span> 32k<span class="p">;</span>
<span class="lineno">24 </span>		proxy_busy_buffers_size    64k<span class="p">;</span>
<span class="lineno">25 </span>		proxy_temp_file_write_size 64k<span class="p">;</span>
<span class="lineno">26 </span>	<span class="o">}</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span>	location ~ ^/<span class="o">(</span>images<span class="p">|</span>javascripts<span class="p">|</span>stylesheets<span class="p">|</span>system<span class="p">|</span>assets<span class="o">)</span>/  <span class="o">{</span>
<span class="lineno">29 </span>		root /home/deployer/apps/my_site/current/public<span class="p">;</span>
<span class="lineno">30 </span>		expires max<span class="p">;</span>
<span class="lineno">31 </span>		<span class="nb">break</span><span class="p">;</span>
<span class="lineno">32 </span>    <span class="o">}</span>
<span class="lineno">33 </span><span class="o">}</span>
</code></pre></div>
</p>

<p>Now restart nginx and visit <a href="http://192.168.5.113/">http://192.168.5.113/</a> ( replace with your server hostname/IP ). You should be all set!</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Jul 22, 2012 - 3 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/07/the-problem-with-pingdom/'> The problem with Pingdom</a> </h1>
      <div class="content"> <p>{% codeblock Time to be Awesome - awesome.rb %}
puts &ldquo;Awesome!&rdquo; unless lame
{% endcodeblock %}</p>

<p><a href="http://www.pingdom.com Pingdom">The problem with pingdom.</a></p>

<p>My money&rsquo;s in that office, right? If she start giving me some bullshit about it ain&rsquo;t there, and we got to go someplace else and get it, I&rsquo;m gonna shoot you in the head then and there. Then I&rsquo;m gonna shoot that bitch in the kneecaps, find out where my goddamn money is. She gonna tell me too. Hey, look at me when I&rsquo;m talking to you, motherfucker. You listen: we go in there, and that nigga Winston or anybody else is in there, you the first motherfucker to get shot. You understand?</p>

<blockquote>
<p>Blockquote is what goes
inside this block here
would you believe that
bullshit?</p>
</blockquote>

<p>Well, the way they make shows is, they make one show. That show&rsquo;s called a pilot. Then they show that show to the people who make shows, and on the strength of that one show they decide if they&rsquo;re going to make more shows. Some pilots get picked and become television programs. Some don&rsquo;t, become nothing. She starred in one of the ones that became nothing.</p>

<p>The path of the righteous man is beset on all sides by the iniquities of the selfish and the tyranny of evil men. Blessed is he who, in the name of charity and good will, shepherds the weak through the valley of darkness, for he is truly his brother&rsquo;s keeper and the finder of lost children. And I will strike down upon thee with great vengeance and furious anger those who would attempt to poison and destroy My brothers. And you will know My name is the Lord when I lay My vengeance upon thee.</p>

<p>Your bones don&rsquo;t break, mine do. That&rsquo;s clear. Your cells react to bacteria and viruses differently than mine. You don&rsquo;t get sick, I do. That&rsquo;s also clear. But for some reason, you and I react the exact same way to water. We swallow it too fast, we choke. We get some in our lungs, we drown. However unreal it may seem, we are connected, you and I. We&rsquo;re on the same curve, just on opposite ends.</p>

<p>Do you see any Teletubbies in here? Do you see a slender plastic tag clipped to my shirt with my name printed on it? Do you see a little Asian child with a blank expression on his face sitting outside on a mechanical helicopter that shakes when you put quarters in it? No? Well, that&rsquo;s what you see at a toy store. And you must think you&rsquo;re in a toy store, because you&rsquo;re here shopping for an infant named Jeb.</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Apr 4, 2012 - 2 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/04/mysql-performance-tuning-constant-references-vs-index-merges-and-intersects/'> MySQL Performance tuning constant references vs index merges and intersects</a> </h1>
      <div class="content"> 

<p>I had a query that, after adding indexes, was taking anywhere from 1.5 to 5ms to return on my local machine. In production and staging environments it was taking 500+ms to return.</p>

<p>The query was producing different optimizer paths:</p>

<h3 id="the-good-optimizer">The good optimizer:</h3>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1 </span><span class="o">***************************</span> <span class="mi">2</span><span class="o">.</span> <span class="n">row</span> <span class="o">***************************</span>
<span class="lineno"> 2 </span>           <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span>
<span class="lineno"> 3 </span>  <span class="ss">select_type</span><span class="p">:</span> <span class="no">SIMPLE</span>
<span class="lineno"> 4 </span>        <span class="ss">table</span><span class="p">:</span> <span class="n">activities</span>
<span class="lineno"> 5 </span>         <span class="ss">type</span><span class="p">:</span> <span class="n">ref</span>
<span class="lineno"> 6 </span><span class="ss">possible_keys</span><span class="p">:</span> <span class="n">index_activities_on_is_archived</span><span class="p">,</span><span class="n">index_activities_on_equipment_id</span><span class="p">,</span><span class="n">index_activities_on_date_completed</span><span class="p">,</span><span class="n">index_activities_on_shop_id</span>
<span class="lineno"> 7 </span>          <span class="ss">key</span><span class="p">:</span> <span class="n">index_activities_on_shop_id</span>
<span class="lineno"> 8 </span>      <span class="ss">key_len</span><span class="p">:</span> <span class="mi">5</span>
<span class="lineno"> 9 </span>          <span class="ss">ref</span><span class="p">:</span> <span class="n">const</span>
<span class="lineno">10 </span>         <span class="ss">rows</span><span class="p">:</span> <span class="mi">1127</span>
<span class="lineno">11 </span>     <span class="ss">filtered</span><span class="p">:</span> <span class="mi">100</span><span class="o">.</span><span class="mo">00</span>
<span class="lineno">12 </span>        <span class="ss">Extra</span><span class="p">:</span> <span class="no">Using</span> <span class="n">where</span>
</code></pre></div>


<h3 id="the-bad-optimizer">The bad optimizer:</h3>

<p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1 </span><span class="o">***************************</span> <span class="mi">2</span><span class="o">.</span> <span class="n">row</span> <span class="o">***************************</span>
<span class="lineno"> 2 </span>           <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span>
<span class="lineno"> 3 </span>  <span class="ss">select_type</span><span class="p">:</span> <span class="no">SIMPLE</span>
<span class="lineno"> 4 </span>        <span class="ss">table</span><span class="p">:</span> <span class="n">activities</span>
<span class="lineno"> 5 </span>         <span class="ss">type</span><span class="p">:</span> <span class="n">index_merge</span>
<span class="lineno"> 6 </span><span class="ss">possible_keys</span><span class="p">:</span> <span class="n">index_activities_on_is_archived</span><span class="p">,</span><span class="n">index_activities_on_equipment_id</span><span class="p">,</span><span class="n">index_activities_on_date_completed</span><span class="p">,</span><span class="n">index_activities_on_shop_id</span>
<span class="lineno"> 7 </span>          <span class="ss">key</span><span class="p">:</span> <span class="n">index_activities_on_shop_id</span><span class="p">,</span><span class="n">index_activities_on_is_archived</span>
<span class="lineno"> 8 </span>      <span class="ss">key_len</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span><span class="mi">2</span>
<span class="lineno"> 9 </span>          <span class="ss">ref</span><span class="p">:</span> <span class="no">NULL</span>
<span class="lineno">10 </span>         <span class="ss">rows</span><span class="p">:</span> <span class="mi">1060</span>
<span class="lineno">11 </span>        <span class="ss">Extra</span><span class="p">:</span> <span class="no">Using</span> <span class="n">intersect</span><span class="p">(</span><span class="n">index_activities_on_shop_id</span><span class="p">,</span><span class="n">index_activities_on_is_archived</span><span class="p">);</span> <span class="no">Using</span> <span class="n">where</span>
</code></pre></div>
</p>

<p>My first thought was it might have been the MySQL versions since I was running 5.5 locally and 5.0 in production, but that turned out not to be the case.</p>

<p>Next was to make sure my database was an exact replica of the one in production. After ensuring this I still ended up with the same results from the optimizer.</p>

<p>My last guess was server configuration. The issue ended up being query-cacheing being turned off in production and staging but not on my local machine. Turning this  on, restarted mysqld, and re-running the query produced the good optmizer results on both my local machine and production.</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Feb 28, 2012 - 6 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/02/why-the-cloud-isnt-for-your-startup/'> Why the Cloud isn&#39;t for your Startup</a> </h1>
      <div class="content"> 

<h3 id="the-lure">The Lure</h3>

<p>You&rsquo;re a new startup, you&rsquo;re tight on funds and don&rsquo;t have the server knowledge to run your own servers, but you plan on growing exponentially very quickly. You have three choices:</p>

<ul>
<li>Suck it up and learn some sysadmin skills (or hire one)</li>
<li>Use a PaaS provider (such as EngineYard, Heroku, or EC2)</li>
<li>Use a mix of both</li>
</ul>

<p>But how do you know which path to take?</p>

<p>I&rsquo;ll be using my experience running Servly for most of this article. I&rsquo;ve been using dedicated servers and virtual machines and the cloud for over 6 years with Servly and other business ventures.</p>

<h3 id="how-valuable-is-your-time-when-shit-hits-the-fan">How valuable is your time when shit hits the fan?</h3>

<p>When using services like EC2 and Amazon, you need to be aware that the support levels are different versus a regular dedicated hosting provider. The last time I had a ticket in with Heroku it had taken well over 4 hours to even get a response.</p>

<p>Support with a dedicated server is different. Of the two hosting providers that I&rsquo;ve been using (<a href="http://wooservers.com">WooServers</a> and <a href="http://voxel.net/">Voxel</a>), I have been given top notch support. Tickets are answered in minutes, and 911&rsquo;s are answered in seconds. Large conglomerate cloud providers just can&rsquo;t beat that service.</p>

<p>There are other considerations to make as well. With traditional cloud offerings (EC2, Rackspace, EngineYard) and dedicated servers you are given root access to the servers, but with Heroku you&rsquo;re locked in to their read-only file system and configuration. You miss out on the ability to tweak your configuration for maximum performance.</p>

<p>With dedicated hardware you can control your infastructure in a much more fine grained way than with a PaaS offering. All of this ties back into support; support that is familiar with the hardware and support that isn&rsquo;t just working for the lowest common denominator in terms of performance based across a massive cloud. With dedicated hardware you get the control and support that one would expect from a paid service, while still being able to customize your system to YOUR needs, and not the needs of the baseline.</p>

<h3 id="benchmark-like-crazy">Benchmark like crazy</h3>

<p>Besides knowing how your application&rsquo;s innards look you also need to know how it performs. Find bottlenecks, memory leaks, optmizations you can make, database indexes you might be missing, etc.</p>

<p>Servly&rsquo;s main focus is the dashboard, and the API server&rsquo;s use to communicate their status updates. Every ~5 minutes the server gets bombarded with hundreds of concurrent requests all vying for database access.</p>

<p>One of the issues I noticed was the occasional 502 Gateway error. There were two problems:</p>

<ul>
<li>Not enough nginx workers</li>
<li>Not enough unicorn works with a high timeout</li>
</ul>

<p>There is no magic formula to find out what the right balance is without running your own tests. When I started testing a simple</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>ab -c <span class="m">100</span> -n <span class="m">1000</span> http://foobar.servly.com/
</code></pre></div>


<p>was returning about 78 failed requests out of 1000. Good, but not good enough.</p>

<p>Editing the nginx configuration several more times I got rid of the writev() failed (107: Transport endpoint is not connected) while sending request to upstream error.  The nginx worker count is now at 16.</p>

<p>The next error was a upstream timeout that would ocassionally happen during that 5 minute burst period. Modifying the number of unicorn slaves to 24, upping the backlog, and tweaking the timeout has reduced all of the gateway errors.</p>

<p>I was now able to scale up from 100-1000 concurrent requests without any failures being reported from ab.</p>

<h3 id="scaling-on-the-cloud-vs-bare-metal">Scaling on the cloud vs bare metal</h3>

<p>For very small projects, or throwaway prototypes, Heroku and other free services are great. However once you&rsquo;re project starts growing, the costs can grow exponentially.</p>

<p>Currently Servly runs on:</p>

<ul>
<li>2.6Ghz Quadcore i5</li>
<li>8GB of RAM</li>
<li>Intel X25 SSD. This provides excellent throughput for both the database and the workers. I also have a spare drive to do backups to (as well as offsite backups).</li>
<li>Server is hosted at <a href="http://wooservers.com/">WooServer</a></li>
</ul>

<p>I also have a MySQL slave for backups in addition to S3 and several spare VM&rsquo;s running as a standby.</p>

<p>Software wise there are:</p>

<ul>
<li>24 Unicorn slaves</li>
<li>10 Background workers</li>
<li>About 3GB of data is being stored in memory from the database cache</li>
</ul>

<h3 id="cost-comparisons">Cost Comparisons</h3>

<h3 id="heroku">Heroku</h3>

<ul>
<li>24 Dynos: $827</li>
<li>10 Workers: $323</li>
<li>Fugu Database: $400</li>
</ul>

<p>Total: $1,587/mo</p>

<h3 id="engine-yard">Engine Yard</h3>

<ul>
<li>1 Extra Large instance</li>
</ul>

<p>Total: $959</p>

<p>I could&rsquo;ve gone with a smaller medium instance, however I need the IO to be as high as possible. Even on this it&rsquo;s still going to be pretty terrible, this also applies to Heroku&rsquo;s offerings as well, since the Fugu database is on the very conservative side and both are layers ontop of Amazon&rsquo;s EC2. [1]</p>

<h3 id="dedicated">Dedicated</h3>

<ul>
<li>2.6ghz Quadcore i5</li>
<li>8GB RAM</li>
<li>80GB Intexl X-25 SSD</li>
<li>80GB Secondary drive</li>
<li>5TB of bandwidth</li>
</ul>

<p>Total: $145/mo</p>

<p>For the price of running Heroku relatively maxed out on dyno&rsquo;s, I could get 11 dedicated servers. Thats roughly:</p>

<ul>
<li>28Ghz on 44 cores</li>
<li>88GB of RAM</li>
<li>880GB of SSD storage</li>
<li>880GB of backup storage</li>
<li>55TB of transfer</li>
</ul>

<h3 id="but-i-don-t-know-anything-about-servers">But I don&rsquo;t know anything about servers</h3>

<p>Learn. You may stumble at first, but there are plenty of outlets to get help at. You can go on Freenode&rsquo;s IRC, Mailing lists, and Stack Exchange. You could even hire a part time sysadmin. Once you really start scaling the cost of using Heroku versus what you could get with bare metal becomes so great that you could eventually just hire a full time sysadmin to manage your dedicated servers.</p>

<h3 id="what-are-others-doing">What are others doing?</h3>

<p>GitHub was a large player to move from the cloud at EngineYard to a more mixed infastructure of bare metal and spot instances to Rackspace. [2] They were able to get nearly 6x the RAM and nearly 4x the CPU cores; one of their main focal points was cost in addition to control, flexibility, capacity.</p>

<p>There are also plenty of success stories over at Heroku&rsquo;s success page: <a href="http://success.heroku.com/">http://success.heroku.com/</a></p>

<h3 id="what-the-cloud-is-good-for">What the cloud is good for</h3>

<p>Temporary data crunching. Have a sudden spike in your job queue? Crank up some more virtual machines to plow through them, then turn them off to save money. All of this can be automated with tools like Blueprint, Puppet, and Chef.</p>

<p>Backups. With the price of S3 being around 8 cents per  GB, its entirely feasable to back everything up off site for disaster recovery to the cloud.</p>

<h3 id="bottom-line">Bottom Line</h3>

<p>You and your team need to evaluate your business needs and decide on what option is best for your company. If you already have a competent sysadmin or a developer who has played both roles before, it would make much more sense to use bare metal. If no one in your team has the experience, or time, to learn devops, then a PaaS solution like Heroku would be a more logical choice.</p>

<p>[1] <a href="http://www.krenger.ch/blog/amazon-ec2-io-performance/">http://www.krenger.ch/blog/amazon-ec2-io-performance/</a></p>

<p>[2] <a href="https://github.com/blog/493-github-is-moving-to-rackspace">https://github.com/blog/493-github-is-moving-to-rackspace</a></p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Feb 27, 2012 - 2 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2012/02/using-rspec-to-test-c-code/'> Using RSpec to test C code</a> </h1>
      <div class="content"> <p>I was working on a C assignment for school and wanted an easy way to test the output of a program running against multiple test cases.</p>

<p>Using RSpec I came up with the following spec:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1 </span><span class="n">describe</span> <span class="s2">&quot;Calculator &quot;</span><span class="k">do</span>
<span class="lineno"> 2 </span>    <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
<span class="lineno"> 3 </span>        <span class="sb">`make clean; make;`</span>
<span class="lineno"> 4 </span>    <span class="k">end</span>
<span class="lineno"> 5 </span>    <span class="n">it</span> <span class="s2">&quot;should accept p1&quot;</span> <span class="k">do</span>
<span class="lineno"> 6 </span>        <span class="sb">`./calc &lt; testing/p1.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;accept&quot;</span>
<span class="lineno"> 7 </span>    <span class="k">end</span>
<span class="lineno"> 8 </span>
<span class="lineno"> 9 </span>    <span class="n">it</span> <span class="s2">&quot;should reject p2&quot;</span> <span class="k">do</span>
<span class="lineno">10 </span>        <span class="sb">`./calc &lt; testing/p2_err.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;reject&quot;</span>
<span class="lineno">11 </span>    <span class="k">end</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span>    <span class="n">it</span> <span class="s2">&quot;should reject p3&quot;</span> <span class="k">do</span>
<span class="lineno">14 </span>        <span class="sb">`./calc &lt; testing/p3_err.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;Variable a duplicate declaration&quot;</span>
<span class="lineno">15 </span>    <span class="k">end</span>
<span class="lineno">16 </span>
<span class="lineno">17 </span>    <span class="n">it</span> <span class="s2">&quot;should reject p4&quot;</span> <span class="k">do</span>
<span class="lineno">18 </span>        <span class="sb">`./calc &lt; testing/p4_err.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;Variable b uninitiated at line 5&quot;</span>
<span class="lineno">19 </span>    <span class="k">end</span>
<span class="lineno">20 </span>
<span class="lineno">21 </span>    <span class="n">it</span> <span class="s2">&quot;should accept p5&quot;</span> <span class="k">do</span>
<span class="lineno">22 </span>        <span class="sb">`./calc &lt; testing/p5.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;accept&quot;</span>
<span class="lineno">23 </span>    <span class="k">end</span>
<span class="lineno">24 </span>
<span class="lineno">25 </span>    <span class="n">it</span> <span class="s2">&quot;should accept p6&quot;</span> <span class="k">do</span>
<span class="lineno">26 </span>        <span class="sb">`./calc &lt; testing/p6.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;accept&quot;</span>
<span class="lineno">27 </span>    <span class="k">end</span>
<span class="lineno">28 </span>
<span class="lineno">29 </span>    <span class="n">it</span> <span class="s2">&quot;should reject p7&quot;</span> <span class="k">do</span>
<span class="lineno">30 </span>        <span class="sb">`./calc &lt; testing/p7_err.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;syntax error at line 9&quot;</span>
<span class="lineno">31 </span>    <span class="k">end</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span>    <span class="n">it</span> <span class="s2">&quot;should reject p8&quot;</span> <span class="k">do</span>
<span class="lineno">34 </span>        <span class="sb">`./calc &lt; testing/p8_err.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;Variable d undeclared&quot;</span>
<span class="lineno">35 </span>    <span class="k">end</span>
<span class="lineno">36 </span>
<span class="lineno">37 </span>    <span class="n">it</span> <span class="s2">&quot;should reject p9&quot;</span> <span class="k">do</span>
<span class="lineno">38 </span>        <span class="sb">`./calc &lt; testing/p9_err.cal`</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span> <span class="s2">&quot;divide by zero at line 7&quot;</span>
<span class="lineno">39 </span>    <span class="k">end</span>
<span class="lineno">40 </span>
<span class="lineno">41 </span><span class="k">end</span>
</code></pre></div>


<p>I was then able to run all my tests with a single command and get informative output.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>.........
<span class="lineno">2 </span>
<span class="lineno">3 </span>Finished in 0.49705 seconds
<span class="lineno">4 </span><span class="m">9</span> examples, <span class="m">0</span> failures
</code></pre></div>
</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Nov 30, 2011 - 1 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2011/11/osx-vim-ctags-exuberant-for-fast-context-switching-in-large-projects/'> OSX &#43; Vim &#43; CTags (Exuberant) for fast context switching in large projects</a> </h1>
      <div class="content"> 

<h3 id="installing-ctags-exuberant">Installing CTags (Exuberant)</h3>

<p>Lets first install ctags-exuberant using Homebrew</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>brew install ctags-exuberant
</code></pre></div>


<p>Remember the path that ctags got installed to, with version 5.8 on my machine it was in:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>/usr/local/Cellar/ctags/5.8/bin/ctags
</code></pre></div>
</p>

<h3 id="setting-up-vim-macvim">Setting up Vim/MacVim</h3>

<p>Download the TagList plugin from <a href="http://vim.sourceforge.net/scripts/script.php?script_id=273">VimOnline</a>.</p>

<p>In your .vimrc file add the following:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span><span class="nb">let </span><span class="nv">Tlist_Ctags_Cmd</span><span class="o">=</span><span class="s1">&#39;/usr/local/Cellar/ctags/5.8/bin/ctags&#39;</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="nb">let </span>g:Tlist_Ctags_Cmd<span class="o">=</span><span class="s1">&#39;/usr/local/Cellar/ctags/5.8/bin/ctags&#39;</span>
<span class="lineno">4 </span>
<span class="lineno">5 </span>fu! CTagGen<span class="o">()</span>
<span class="lineno">6 </span>    :execute <span class="s2">&quot;!&quot;</span> . g:Tlist_Ctags_Cmd .  <span class="s2">&quot; -R .&quot;</span>
<span class="lineno">7 </span>endfunction
<span class="lineno">8 </span>
<span class="lineno">9 </span>nmap &lt;silent&gt; :ctg :call CTagGen<span class="o">()</span>
</code></pre></div>
</p>

<p>Open up vim/MacVim, and type
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>:ctg
</code></pre></div>
</p>

<p>You can then go to a controller for example:</p>

<p>Type in:
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>:Tlist
</code></pre></div>
</p>

<p>And the follow should appear.</p>

<p><img src="{{ site.s3 }}posts/ctag_vim.jpg" alt="ctag list" /></p>

<p>Lets say I&rsquo;ve got my cursor on StoryType and I want to go to the model, I can just hit Ctrl+] to get there. You can now do this for any method (helpers, methods, anything thats in your ctags file!).</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Nov 21, 2011 - 1 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2011/11/cucumber-and-mysql2-error-lock-when-deleting-records/'> Cucumber and Mysql2::Error Lock when deleting records</a> </h1>
      <div class="content"> <p>I was writing some cucumber features for reru_scrum when I ran into an issue with destroying user records and Mysql2 throwing a Lock error.</p>

<p>The full error:
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1 </span><span class="no">Mysql2</span><span class="o">::</span><span class="ss">Error</span><span class="p">:</span> <span class="no">Lock</span> <span class="n">wait</span> <span class="n">timeout</span> <span class="n">exceeded</span><span class="p">;</span> <span class="n">try</span> <span class="n">restarting</span> <span class="ss">transaction</span><span class="p">:</span> <span class="no">UPDATE</span> <span class="sb">`users`</span> <span class="no">SET</span> <span class="sb">`last_sign_in_at`</span> <span class="o">=</span> <span class="s1">&#39;2011-11-22 00:06:32&#39;</span><span class="p">,</span> <span class="sb">`current_sign_in_at`</span> <span class="o">=</span> <span class="s1">&#39;2011-11-22 00:11:28&#39;</span><span class="p">,</span> <span class="sb">`sign_in_count`</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="sb">`updated_at`</span> <span class="o">=</span> <span class="s1">&#39;2011-11-22 00:11:28&#39;</span> <span class="no">WHERE</span> <span class="sb">`users`</span><span class="o">.</span><span class="n-Operator">`</span><span class="nb">id</span><span class="sb">` = 1</span>
</code></pre></div>
</p>

<p>A simple solution is to use the <a href="https://github.com/bmabey/database_cleaner">database_cleaner</a> gem.</p>

<p>Inside your features/support/env.rb file:
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1 </span><span class="k">begin</span>
<span class="lineno">2 </span>  <span class="nb">require</span> <span class="s1">&#39;database_cleaner&#39;</span>
<span class="lineno">3 </span>  <span class="nb">require</span> <span class="s1">&#39;database_cleaner/cucumber&#39;</span>
<span class="lineno">4 </span>  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="ss">:truncation</span>
<span class="lineno">5 </span><span class="k">rescue</span> <span class="no">NameError</span>
<span class="lineno">6 </span>  <span class="k">raise</span> <span class="s2">&quot;You need to add database_cleaner to your Gemfile (in the :test group) if you wish to use it.&quot;</span>
<span class="lineno">7 </span><span class="k">end</span>
</code></pre></div>
</p>

<p>A good idea is to create the before and after hooks to use the DatabaseCleaner.start and DatabaseCleaner.clean methods.</p>

<p>Inside features/support/hooks.rb:</p>

<p><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1 </span><span class="no">Before</span> <span class="k">do</span>
<span class="lineno">2 </span>  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">start</span>
<span class="lineno">3 </span><span class="k">end</span>
<span class="lineno">4 </span>
<span class="lineno">5 </span><span class="no">After</span> <span class="k">do</span> <span class="o">|</span><span class="n">scenario</span><span class="o">|</span>
<span class="lineno">6 </span>  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean</span>
<span class="lineno">7 </span><span class="k">end</span>
</code></pre></div>
</p>

<p>You should then be able to run your features and have your database cleaned between steps.</p>
 </div>
    </article>
    
    <article class="post">
      <div class="date"> Nov 17, 2011 - 1 minutes</div>
      <h1 class="title"> <a href='https://joshrendek.com/2011/11/coffeescript-onclick-referencing-this-not-working/'> Coffeescript onclick referencing this not working</a> </h1>
      <div class="content"> <p>When defining a event listener for objects in Coffeescript you nede to make sure you use a -&gt; &ndash; using a =&gt; will result in any references to attr() be &ldquo;undefined&rdquo;</p>

<p>Here is an example of some correct on click bindings that use the attr() methods</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1 </span>  <span class="nx">jQuery</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="o">-&gt;</span>
<span class="lineno">2 </span>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[id^=story_]&#39;</span><span class="p">).</span><span class="nx">click</span> <span class="o">-&gt;</span>
<span class="lineno">3 </span>    <span class="nx">$</span><span class="p">(</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span>  <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_loader&quot;</span><span class="p">)</span>
<span class="lineno">4 </span>      <span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;/projects/&#39;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;project_id&#39;</span><span class="p">)</span> <span class="o">+</span>
<span class="lineno">5 </span>      <span class="s1">&#39;/story_types/&#39;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;story_type_id&#39;</span><span class="p">)</span> <span class="o">+</span>
<span class="lineno">6 </span>      <span class="s1">&#39;/stories/&#39;</span><span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;story_id&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/tasks/new&#39;</span><span class="p">)</span>
</code></pre></div>

 </div>
    </article>
    
  </div>

  <div class="sidebar">
  <section>
    <h1>Projects & Software</h1>
    <ul>
      <li><a href="https://github.com/joshrendek/docker-conductor">Docker Conductor</a> is a docker orchestration tool.</li>
      <li><a href="http://sshpot.com/">sshpot.com</a> is a SSH honeypot service written in Go (both web service and client are open source).</li>
      <li><a href="http://ifcfg.net/">ifcfg.net</a> is a simple 'what is my IP' service with a few extra RESTful endpoints.</li>

      <li><a href="/projects/">View More</a>

      <li><a href="https://github.com/joshrendek?tab=repositories"><img src="/images/github.png" style='border: none;'> More on GitHub</a></li>
      <li><a href="https://rubygems.org/profiles/joshrendek">Gems @ RubyGems</a></li>
    </ul>
  </section>

  <section>
    <h1>Other Blogs</h1>
    <ul>
      <li><a href="http://tendermeatlove.com">Tender Meat Love</a> is my blog about cooking.</li>
      <li><a href="http://hydronerd.com">Hydro Nerd</a> is my blog about hydroponics and gardening.</li>
    </ul>
  </section>

  <section>
    <h1>Recent Posts</h1>
    <ul>
      
      <li><a href="https://joshrendek.com/2016/06/building-honeypots-and-analyzing-linux-malware/">Building honeypots and analyzing linux malware</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/understanding-elasticsearch-performance/">Understanding ElasticSearch Performance</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/building-a-distributed-waitgroup-with-go-and-redis/">Building a distributed WaitGroup with Go and Redis</a></li>
      
      <li><a href="https://joshrendek.com/2015/11/docker-and-ping-sendmsg-operation-not-permitted/">Docker and ping: sendmsg: Operation not permitted</a></li>
      
      <li><a href="https://joshrendek.com/2015/10/influx-alert/">Influx Alert</a></li>
      
    </ul>
  </section>

</div>

</main>

<div class="page-nav">
  <div class="page-prev">
    
        <a href="/page/3/" title="Previous page" > &lt;&lt; </a>
    
  </div>

  <div class="page-num">
    4/12
  </div>

  <div class="page-next">
    
    <a href="/page/5/" title="Next page"> >> </a>
    
  </div>
</div> 


  <footer>

  <div class="social-links-footer">

  

  

  

  

  

  <div class="social-link">
  <a href="https://joshrendek.com/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright">  Copyright 2008-2017 Josh Rendek </div>

  </footer>

</body>
</html>

